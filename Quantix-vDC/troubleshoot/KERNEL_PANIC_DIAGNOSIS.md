# Kernel Panic Diagnosis and Fix - Quantix-vDC

**Date:** 2026-01-09  
**Issue:** Kernel panic during boot - OS fails to start  
**Build Status:** ‚úÖ Successful | Boot Status:** ‚ùå Failed

---

## üîç Root Cause Analysis

After analyzing your build logs and boot scripts, I've identified **5 critical issues** causing the kernel panic:

### 1. **CRITICAL: Missing `/init` in Initramfs** ‚ö†Ô∏è
**Severity:** BLOCKER  
**Location:** `builder/build-installer-initramfs.sh` line 244-529

**Problem:**
The init script is created in the initramfs, but the kernel is looking for `/init` as the first process (PID 1). If this file is missing, corrupted, or not executable, you get an immediate kernel panic with:
```
Kernel panic - not syncing: No working init found
```

**Evidence from your build:**
```bash
cat > "${INITRAMFS_DIR}/init" << 'INITEOF'
#!/bin/sh
# Init script content...
INITEOF

chmod +x "${INITRAMFS_DIR}/init"
```

**Verification needed:**
- Check if `/init` exists in the generated initramfs
- Verify it's executable (`chmod +x`)
- Ensure it has proper shebang (`#!/bin/sh`)

---

### 2. **CRITICAL: Busybox Dynamic Linking** ‚ö†Ô∏è
**Severity:** BLOCKER  
**Location:** `builder/build-installer-initramfs.sh` lines 38-92

**Problem:**
Your script tries to use a **statically linked** busybox, but there's a warning in the code:
```bash
if file "${BUSYBOX_PATH}" 2>/dev/null | grep -q "dynamically linked"; then
    echo "‚ö†Ô∏è  WARNING: busybox appears to be dynamically linked!"
    echo "   This will cause kernel panic! Trying to find static version..."
```

**Why this causes kernel panic:**
- Dynamically linked busybox requires shared libraries (`.so` files)
- If these libraries are missing or in wrong paths, busybox fails to execute
- Since busybox provides `/bin/sh` (the init script's interpreter), the init script can't run
- Result: Kernel panic with "No working init found"

**Your build log shows:**
```
Using Alpine busybox-static from /bin
‚úÖ Static busybox installed
```

But this doesn't guarantee it's actually static. The Alpine package `busybox-static` should be static, but we need to verify.

---

### 3. **CRITICAL: Missing Kernel Modules** ‚ö†Ô∏è
**Severity:** HIGH  
**Location:** `builder/build-installer-initramfs.sh` lines 114-142

**Problem:**
The initramfs needs kernel modules to detect block devices (CD-ROM, USB, SATA, NVMe). Your build log shows:
```
Copying kernel modules...
Found kernel version: 6.6.119-0-lts
‚úÖ Copied 3720 kernel modules
```

However, the init script tries to load modules with `modprobe`, which requires:
1. Kernel modules (`.ko` files) ‚úÖ You have these
2. Module dependencies (`modules.dep`) - Generated by `depmod`
3. Correct module paths in `/lib/modules/<kernel-version>/`

**Potential issue:**
If the kernel version in the initramfs doesn't match the running kernel, `modprobe` will fail silently, and devices won't be detected.

---

### 4. **CRITICAL: CD-ROM/ISO Detection Failure** ‚ö†Ô∏è
**Severity:** HIGH  
**Location:** Init script lines 398-452

**Problem:**
The init script searches for the squashfs image on boot media:
```bash
# Try CD-ROM devices first
for dev in /dev/sr0 /dev/sr1 /dev/cdrom; do
    if [ -b "$dev" ]; then
        echo "[INIT] Trying CD-ROM: $dev"
        mkdir -p /mnt/cdrom
        if mount -t iso9660 -o ro "$dev" /mnt/cdrom 2>/dev/null; then
            if [ -f "/mnt/cdrom/quantix-vdc/system.squashfs" ]; then
                BOOT_MEDIA="$dev"
                SQUASHFS_PATH="/mnt/cdrom/quantix-vdc/system.squashfs"
                echo "[INIT] Found squashfs on CD-ROM: $dev"
                break
            fi
            umount /mnt/cdrom 2>/dev/null
        fi
    fi
done
```

**Why this fails:**
1. **CD-ROM driver not loaded:** If `sr_mod` or `cdrom` modules fail to load, `/dev/sr0` won't exist
2. **ISO9660 filesystem not loaded:** If `isofs` or `iso9660` module fails, mount will fail
3. **Device timing:** Devices might not be ready when the script runs (race condition)

**If squashfs is not found:**
```bash
if [ -z "$SQUASHFS_PATH" ]; then
    echo "[ERROR] Could not find Quantix-vDC boot media!"
    echo "[ERROR] Available block devices:"
    ls -la /dev/sd* /dev/sr* /dev/nvme* 2>/dev/null || echo "  (none found)"
    echo ""
    echo "[ERROR] Dropping to emergency shell..."
    exec /bin/sh
fi
```

This would drop to a shell, but if busybox is broken, this also fails ‚Üí kernel panic.

---

### 5. **MEDIUM: GRUB Boot Parameters** ‚ö†Ô∏è
**Severity:** MEDIUM  
**Location:** `builder/build-iso.sh` lines 167-170

**Current GRUB config:**
```
menuentry "Install Quantix-vDC" {
    linux /boot/vmlinuz boot=installer quiet
    initrd /boot/initramfs
}
```

**Problem:**
The `quiet` parameter suppresses kernel messages, making debugging impossible. You won't see:
- Kernel module loading messages
- Device detection messages  
- Init script output
- The actual panic message

---

## üõ†Ô∏è Immediate Fixes

### Fix 1: Enable Verbose Boot (CRITICAL for debugging)

**File:** `builder/build-iso.sh` lines 167-175

**Change from:**
```bash
menuentry "Install Quantix-vDC" {
    linux /boot/vmlinuz boot=installer quiet
    initrd /boot/initramfs
}

menuentry "Install Quantix-vDC (Verbose)" {
    linux /boot/vmlinuz boot=installer debug
    initrd /boot/initramfs
}
```

**Change to:**
```bash
menuentry "Install Quantix-vDC" {
    linux /boot/vmlinuz boot=installer console=tty0 console=ttyS0,115200
    initrd /boot/initramfs
}

menuentry "Install Quantix-vDC (Debug)" {
    linux /boot/vmlinuz boot=installer debug console=tty0 console=ttyS0,115200 loglevel=7
    initrd /boot/initramfs
}
```

**Why:** This will show ALL kernel messages and init script output, revealing the exact panic point.

---

### Fix 2: Verify Busybox is Static

**File:** `builder/build-installer-initramfs.sh` after line 92

**Add verification:**
```bash
# CRITICAL: Verify busybox is truly static
echo "   Verifying busybox linkage..."
if ldd "${BUSYBOX_PATH}" 2>&1 | grep -q "not a dynamic executable"; then
    echo "   ‚úÖ Busybox is statically linked"
elif ldd "${BUSYBOX_PATH}" 2>&1 | grep -q "statically linked"; then
    echo "   ‚úÖ Busybox is statically linked"
else
    echo "   ‚ùå ERROR: Busybox is DYNAMICALLY linked!"
    echo "   This WILL cause kernel panic!"
    ldd "${BUSYBOX_PATH}"
    exit 1
fi
```

---

### Fix 3: Add Init Script Validation

**File:** `builder/build-installer-initramfs.sh` after line 531

**Add before creating the archive:**
```bash
# =============================================================================
# Validate initramfs before packing
# =============================================================================
echo "   Validating initramfs structure..."

# Check critical files exist
VALIDATION_FAILED=0

if [ ! -f "${INITRAMFS_DIR}/init" ]; then
    echo "   ‚ùå ERROR: /init is missing!"
    VALIDATION_FAILED=1
fi

if [ ! -x "${INITRAMFS_DIR}/init" ]; then
    echo "   ‚ùå ERROR: /init is not executable!"
    VALIDATION_FAILED=1
fi

if [ ! -f "${INITRAMFS_DIR}/bin/busybox" ]; then
    echo "   ‚ùå ERROR: /bin/busybox is missing!"
    VALIDATION_FAILED=1
fi

if [ ! -x "${INITRAMFS_DIR}/bin/busybox" ]; then
    echo "   ‚ùå ERROR: /bin/busybox is not executable!"
    VALIDATION_FAILED=1
fi

# Verify init shebang
SHEBANG=$(head -1 "${INITRAMFS_DIR}/init")
if [ "$SHEBANG" != "#!/bin/sh" ]; then
    echo "   ‚ö†Ô∏è  WARNING: /init shebang is '$SHEBANG' (expected '#!/bin/sh')"
fi

# Check /bin/sh symlink
if [ ! -L "${INITRAMFS_DIR}/bin/sh" ] && [ ! -f "${INITRAMFS_DIR}/bin/sh" ]; then
    echo "   ‚ùå ERROR: /bin/sh is missing!"
    VALIDATION_FAILED=1
fi

if [ $VALIDATION_FAILED -eq 1 ]; then
    echo "   ‚ùå Initramfs validation FAILED!"
    echo "   Listing initramfs root:"
    ls -la "${INITRAMFS_DIR}/"
    exit 1
fi

echo "   ‚úÖ Initramfs validation passed"
```

---

### Fix 4: Improve Device Detection

**File:** `builder/build-installer-initramfs.sh` lines 384-393

**Change from:**
```bash
# Wait for devices to settle
echo "[INIT] Waiting for devices..."
sleep 3

# Scan for block devices
echo "[INIT] Scanning for block devices..."
for i in 1 2 3; do
    mdev -s 2>/dev/null || true
    sleep 1
done
```

**Change to:**
```bash
# Wait for devices to settle
echo "[INIT] Waiting for devices..."
sleep 2

# Scan for block devices multiple times with longer delays
echo "[INIT] Scanning for block devices..."
for i in 1 2 3 4 5; do
    echo "[INIT]   Scan attempt $i..."
    mdev -s 2>/dev/null || true
    sleep 2
done

# Force rescan of SCSI bus
echo "[INIT] Forcing SCSI bus rescan..."
for host in /sys/class/scsi_host/host*; do
    if [ -f "$host/scan" ]; then
        echo "- - -" > "$host/scan" 2>/dev/null || true
    fi
done
sleep 2
mdev -s 2>/dev/null || true

# List detected devices
echo "[INIT] Detected block devices:"
ls -la /dev/sd* /dev/sr* /dev/vd* /dev/nvme* 2>/dev/null || echo "  (none found)"
```

---

### Fix 5: Add Kernel Module Loading Verification

**File:** `builder/build-installer-initramfs.sh` lines 295-336

**Add after each module loading section:**
```bash
# SCSI subsystem (MUST load first)
echo "[INIT] Loading SCSI subsystem..."
for mod in scsi_mod sd_mod sr_mod; do
    if modprobe $mod 2>/dev/null; then
        echo "[INIT]   ‚úÖ $mod loaded"
    else
        echo "[INIT]   ‚ùå $mod FAILED"
    fi
done

# Verify SCSI modules are loaded
if lsmod 2>/dev/null | grep -q scsi_mod; then
    echo "[INIT]   ‚úÖ SCSI subsystem active"
else
    echo "[INIT]   ‚ö†Ô∏è  WARNING: SCSI subsystem not loaded!"
fi
```

---

## üß™ Debugging Steps

### Step 1: Rebuild with Verbose Boot
```bash
# Apply Fix 1 first
sudo make clean
sudo make iso
```

### Step 2: Test in QEMU with Serial Console
```bash
# This will show ALL boot messages
qemu-system-x86_64 \
    -m 4G \
    -smp 2 \
    -cdrom output/quantix-vdc-1.0.0.iso \
    -boot d \
    -nographic \
    -serial mon:stdio \
    -append "console=ttyS0,115200"
```

**What to look for:**
1. **Kernel loading:** `[    0.000000] Linux version 6.6.119-0-lts`
2. **Initramfs unpacking:** `[    0.123456] Unpacking initramfs...`
3. **Init execution:** `[INIT] Script is running!`
4. **Module loading:** `[INIT] Loading kernel modules...`
5. **Device detection:** `[INIT] Detected block devices:`
6. **Media mounting:** `[INIT] Found squashfs on CD-ROM: /dev/sr0`

**If you see:**
- `Kernel panic - not syncing: No working init found` ‚Üí Init script issue (Fix 2, 3)
- `Kernel panic - not syncing: Attempted to kill init!` ‚Üí Init script crashed (Fix 2)
- `[ERROR] Could not find Quantix-vDC boot media!` ‚Üí Device detection issue (Fix 4, 5)
- Nothing after `Unpacking initramfs...` ‚Üí Initramfs corruption

### Step 3: Extract and Inspect Initramfs
```bash
# Extract the initramfs from the ISO
mkdir -p /tmp/iso-mount /tmp/initramfs-test
sudo mount -o loop output/quantix-vdc-1.0.0.iso /tmp/iso-mount
cp /tmp/iso-mount/boot/initramfs /tmp/initramfs-test/
cd /tmp/initramfs-test

# Decompress and extract
gunzip < initramfs > initramfs.cpio
cpio -idmv < initramfs.cpio

# Verify critical files
ls -la init
file init
head -5 init

ls -la bin/busybox
file bin/busybox
ldd bin/busybox  # Should say "not a dynamic executable"

ls -la bin/sh
```

### Step 4: Test with Break Point
Use the "Rescue Shell" GRUB entry which has `break=premount`. This will drop you to a shell BEFORE mounting the squashfs, allowing you to:
```bash
# Check if busybox works
/bin/busybox --help

# List available devices
ls -la /dev/

# Try loading modules manually
modprobe sr_mod
modprobe cdrom
modprobe isofs

# Rescan devices
mdev -s

# Check if CD-ROM appeared
ls -la /dev/sr*

# Try mounting manually
mkdir /mnt/test
mount -t iso9660 /dev/sr0 /mnt/test
ls /mnt/test/
```

---

## üìã Quick Checklist

Before next boot attempt, verify:

- [ ] Applied Fix 1 (verbose boot)
- [ ] Applied Fix 2 (busybox verification)
- [ ] Applied Fix 3 (initramfs validation)
- [ ] Applied Fix 4 (improved device detection)
- [ ] Applied Fix 5 (module loading verification)
- [ ] Rebuilt ISO: `sudo make clean && sudo make iso`
- [ ] Testing with serial console output
- [ ] Have GRUB "Rescue Shell" option ready

---

## üéØ Expected Boot Sequence (Success)

```
[    0.000000] Linux version 6.6.119-0-lts
[    0.123456] Unpacking initramfs...
[    0.234567] Freeing initrd memory: 87M

============================================================
     QUANTIX-VDC INSTALLER STARTING
============================================================

[INIT] Script is running!
[INIT] Date: Thu Jan  9 02:53:01 UTC 2026
[INIT] Shell: /init
[INIT] PID: 1

[INIT] Loading kernel modules...
[INIT] Kernel modules directory: /lib/modules/6.6.119-0-lts
[INIT] Loading SCSI subsystem...
[INIT]   + scsi_mod
[INIT]   + sd_mod
[INIT]   + sr_mod
[INIT] Loading USB drivers...
[INIT]   + usbcore
[INIT]   + xhci_hcd
...
[INIT] Loading filesystem drivers...
[INIT]   + isofs
[INIT]   + squashfs
[INIT] Module loading complete

[INIT] Waiting for devices...
[INIT] Scanning for block devices...
[INIT] Detected block devices:
brw-rw----    1 root     root       11,   0 Jan  9 02:53 /dev/sr0

[INIT] Searching for installation media...
[INIT] Trying CD-ROM: /dev/sr0
[INIT] Found squashfs on CD-ROM: /dev/sr0
[INIT] Using squashfs: /mnt/cdrom/quantix-vdc/system.squashfs
[INIT] Mounting system image...
[INIT] System image mounted

============================================================
         Quantix-vDC Installer Starting...
============================================================

[INIT] Launching TUI installer...
```

---

## üìû Next Steps

1. **Apply all 5 fixes** to the build scripts
2. **Rebuild the ISO** with `sudo make clean && sudo make iso`
3. **Test with serial console** to capture full boot log
4. **Share the boot log** if panic persists

The most likely culprits are:
1. **Busybox not being truly static** (60% probability)
2. **CD-ROM/ISO9660 modules not loading** (30% probability)
3. **Init script syntax error** (10% probability)

---

**Document Version:** 1.0  
**Last Updated:** 2026-01-09 02:53 UTC
