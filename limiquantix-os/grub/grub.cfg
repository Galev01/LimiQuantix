# =============================================================================
# Quantix-OS GRUB Configuration
# =============================================================================
# This is the master GRUB configuration for installed systems.
# Supports A/B partitioning with automatic rollback.
# =============================================================================

# Default settings
set timeout=5
set default=0

# Load video modules for graphical boot
insmod all_video
insmod gfxterm
set gfxmode=auto
terminal_output gfxterm

# Set colors
set menu_color_normal=white/black
set menu_color_highlight=black/light-cyan

# Load saved environment (for A/B tracking)
load_env

# Determine which system to boot
if [ "${quantix_boot}" = "B" ]; then
    set active_system="QUANTIX-B"
    set fallback_system="QUANTIX-A"
else
    set active_system="QUANTIX-A"
    set fallback_system="QUANTIX-B"
fi

# Check for pending update (rollback protection)
if [ "${quantix_pending}" = "1" ]; then
    set timeout=10
    set pending_msg=" [PENDING VERIFICATION]"
else
    set pending_msg=""
fi

# =============================================================================
# Boot Menu Entries
# =============================================================================

menuentry "Quantix-OS${pending_msg}" --id quantix-default {
    echo "Loading Quantix-OS from ${active_system}..."
    search --label --set=root ${active_system}
    linux /boot/vmlinuz root=LABEL=${active_system} ro quiet loglevel=3
    initrd /boot/initramfs
}

menuentry "Quantix-OS (System A)" --id quantix-a {
    echo "Loading Quantix-OS from System A..."
    search --label --set=root QUANTIX-A
    linux /boot/vmlinuz root=LABEL=QUANTIX-A ro quiet
    initrd /boot/initramfs
}

menuentry "Quantix-OS (System B)" --id quantix-b {
    echo "Loading Quantix-OS from System B..."
    search --label --set=root QUANTIX-B
    linux /boot/vmlinuz root=LABEL=QUANTIX-B ro quiet
    initrd /boot/initramfs
}

menuentry "Quantix-OS (Recovery Mode)" --id quantix-recovery {
    echo "Loading Quantix-OS in recovery mode..."
    search --label --set=root ${active_system}
    linux /boot/vmlinuz root=LABEL=${active_system} ro single
    initrd /boot/initramfs
}

menuentry "Quantix-OS (Debug Mode)" --id quantix-debug {
    echo "Loading Quantix-OS with debug output..."
    search --label --set=root ${active_system}
    linux /boot/vmlinuz root=LABEL=${active_system} ro debug loglevel=7
    initrd /boot/initramfs
}

# =============================================================================
# System Utilities
# =============================================================================

submenu "System Utilities" {
    menuentry "Reboot" {
        reboot
    }
    
    menuentry "Shutdown" {
        halt
    }
    
    menuentry "UEFI Firmware Setup" {
        fwsetup
    }
}
