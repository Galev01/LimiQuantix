# Workflow State

## Current Status: COMPLETED

## Active Workflow: Host Registration Token Redesign

**Date:** January 8, 2026

### Summary

Redesigned the host registration flow to address three key requirements:
1. Token is generated BY the host (not the vDC)
2. Token expires after 1 hour
3. Host shares all resources (local storage, NFS, iSCSI)
4. Host must join a specific cluster (mandatory)

---

## Changes Made

### Quantix-OS TUI (Rust - Console Interface)

**File:** `Quantix-OS/console-tui/src/main.rs`

- Updated F4 menu item from "Join/Leave Cluster" → "Generate Registration Token"
- Redesigned cluster screen to focus on token generation
- Added `GeneratedToken` struct to track token and expiry
- Added `generate_registration_token()` function that calls Node Daemon API
- Added `extract_json_field()` helper for parsing JSON responses
- Removed old join cluster form (vDC now initiates the connection)
- Shows token prominently with remaining time
- Instructions for how to add host via vDC UI

### Node Daemon (Rust)

**File:** `agent/limiquantix-node/src/http_server.rs`

- Added `POST /api/v1/registration/token` - Generate 1-hour registration token
- Added `GET /api/v1/registration/token` - Get current token if valid
- Added `GET /api/v1/registration/discovery` - Return full hardware inventory
- Added NFS mount detection from `/proc/mounts`
- Added iSCSI target discovery from `/sys/class/iscsi_session`
- Token format: `QUANTIX-XXXX-XXXX-XXXX` (12-byte random Base32)

**File:** `agent/limiquantix-node/Cargo.toml`
- Added `gethostname = "0.4"` and `libc = "0.2"` dependencies

### Control Plane (Go)

**File:** `backend/internal/server/host_registration_handler.go` (NEW)
- `POST /api/nodes/discover` - Connect to host, validate token, fetch resources
- `POST /api/nodes/register` - Register host with cluster

**File:** `backend/internal/server/server.go`
- Registered new host registration handler routes

### Frontend (React)

**File:** `frontend/src/components/host/AddHostModal.tsx` (REWRITTEN)
- Multi-step wizard flow:
  1. Input: Host IP, Token, Cluster selection
  2. Connecting: Validate token with host
  3. Discovery: Display resources (CPU, Memory, Storage, Network, GPUs)
  4. Confirm: Add host to cluster
  5. Success/Error states
- Removed old token generation flow (token now comes from host)

### Documentation

**File:** `docs/ui/000076-host-registration-flow.md` (NEW)
- Complete documentation of new registration flow
- API endpoints reference
- Token format and security considerations
- Usage instructions

---

## New Registration Flow

```
┌─────────────────────┐                    ┌─────────────────────┐
│   Quantix-OS Host   │                    │    Quantix-vDC      │
│   (F4 in Console)   │                    │    (Admin UI)       │
│                     │                    │                     │
│  1. Press F4        │                    │                     │
│  2. Press G to      │                    │                     │
│     Generate Token  │                    │                     │
│                     │                    │                     │
│  Token displayed:   │                    │  3. Click "Add Host"│
│  QUANTIX-XXXX-XXXX  │ ─────────────────► │  4. Enter Host IP   │
│  (valid 60 min)     │   Admin copies     │  5. Paste Token     │
│                     │                    │  6. Select Cluster  │
│                     │                    │  7. Click Connect   │
│                     │                    │                     │
│                     │ ◄───────────────── │  vDC validates      │
│                     │   Validate token   │  token & discovers  │
│                     │   + discovery      │  resources          │
│                     │                    │                     │
│                     │                    │  8. Review resources│
│  Host joins cluster │ ◄───────────────── │  9. Confirm add     │
└─────────────────────┘                    └─────────────────────┘
```

---

## Key Design Decisions

1. **Token generated on host**: More secure - vDC never stores/generates secrets
2. **1-hour expiration**: Balance between usability and security
3. **Cluster mandatory**: Hosts cannot exist without cluster context
4. **Full resource discovery**: Shows all storage types before admin confirms

---

## Previous Workflows

Archived to `completed_workflow.md`.
