<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LimiQuantix Console</title>
    <link rel="icon" type="image/svg+xml" href="/vite.svg">
    
    <style>
        :root {
            --bg-base: #0a0a0f;
            --bg-surface: #12121a;
            --bg-elevated: #1a1a24;
            --bg-hover: #252530;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-muted: #64748b;
            --accent: #9333ea;
            --accent-hover: #a855f7;
            --success: #22c55e;
            --warning: #f59e0b;
            --error: #ef4444;
            --border: rgba(255, 255, 255, 0.08);
            --border-hover: rgba(255, 255, 255, 0.12);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            background: var(--bg-base);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }
        
        #app {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        /* Enhanced Toolbar */
        .toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 12px;
            background: linear-gradient(180deg, var(--bg-surface) 0%, rgba(18, 18, 26, 0.95) 100%);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
            z-index: 100;
            backdrop-filter: blur(12px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        .toolbar-section {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .toolbar-divider {
            width: 1px;
            height: 24px;
            background: var(--border);
            margin: 0 8px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: var(--accent);
            padding: 6px 10px;
            border-radius: 8px;
            background: rgba(147, 51, 234, 0.1);
        }
        
        .logo svg {
            width: 20px;
            height: 20px;
        }
        
        .vm-name {
            font-weight: 500;
            color: var(--text-primary);
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .status-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 9999px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-badge.connecting {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }
        
        .status-badge.connected {
            background: rgba(34, 197, 94, 0.15);
            color: var(--success);
        }
        
        .status-badge.disconnected {
            background: rgba(239, 68, 68, 0.15);
            color: var(--error);
        }
        
        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }
        
        .status-badge.connected .status-dot {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Enhanced Expandable Buttons */
        .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0;
            padding: 8px;
            border: 1px solid transparent;
            border-radius: 8px;
            background: var(--bg-elevated);
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
            overflow: hidden;
            min-width: 34px;
            height: 34px;
        }
        
        .btn svg {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
            transition: transform 0.2s ease;
        }
        
        .btn .btn-label {
            max-width: 0;
            opacity: 0;
            overflow: hidden;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            margin-left: 0;
        }
        
        .btn:hover {
            background: var(--bg-hover);
            border-color: var(--border-hover);
            color: var(--text-primary);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        .btn:hover svg {
            transform: scale(1.1);
        }
        
        .btn:hover .btn-label {
            max-width: 120px;
            opacity: 1;
            margin-left: 8px;
        }
        
        .btn:active {
            transform: scale(0.96);
        }
        
        .btn.btn-success:hover {
            background: rgba(34, 197, 94, 0.15);
            border-color: rgba(34, 197, 94, 0.3);
            color: var(--success);
        }
        
        .btn.btn-warning:hover {
            background: rgba(245, 158, 11, 0.15);
            border-color: rgba(245, 158, 11, 0.3);
            color: var(--warning);
        }
        
        .btn.btn-danger:hover {
            background: rgba(239, 68, 68, 0.15);
            border-color: rgba(239, 68, 68, 0.3);
            color: var(--error);
        }
        
        .btn.btn-accent:hover {
            background: rgba(147, 51, 234, 0.15);
            border-color: rgba(147, 51, 234, 0.3);
            color: var(--accent-hover);
        }
        
        .btn-primary {
            background: var(--accent);
            color: white;
            padding: 8px 16px;
            gap: 8px;
        }
        
        .btn-primary .btn-label {
            max-width: none;
            opacity: 1;
            margin-left: 0;
        }
        
        .btn-primary:hover {
            background: var(--accent-hover);
            color: white;
        }
        
        /* VM Menu Dropdown */
        .dropdown-container {
            position: relative;
        }
        
        .dropdown-menu {
            position: absolute;
            top: calc(100% + 6px);
            left: 0;
            min-width: 200px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 10px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4), 0 2px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            padding: 6px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-8px);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .dropdown-container:hover .dropdown-menu,
        .dropdown-menu.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .dropdown-section-title {
            padding: 6px 10px 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
        }
        
        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
            padding: 8px 10px;
            border: none;
            border-radius: 6px;
            background: transparent;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            text-align: left;
        }
        
        .dropdown-item svg {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
        }
        
        .dropdown-item:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        
        .dropdown-item.success:hover {
            background: rgba(34, 197, 94, 0.15);
            color: var(--success);
        }
        
        .dropdown-item.warning:hover {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }
        
        .dropdown-item.danger:hover {
            background: rgba(239, 68, 68, 0.15);
            color: var(--error);
        }
        
        .dropdown-divider {
            height: 1px;
            background: var(--border);
            margin: 6px 4px;
        }
        
        .dropdown-item .spinner-small {
            width: 14px;
            height: 14px;
            border: 2px solid currentColor;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        .quality-check {
            color: var(--success);
            font-weight: bold;
        }
        
        .quality-option.active .quality-check {
            display: inline !important;
        }
        
        .toggle-indicator {
            font-size: 10px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(34, 197, 94, 0.2);
            color: var(--success);
        }
        
        .toggle-indicator.off {
            background: rgba(239, 68, 68, 0.2);
            color: var(--error);
        }
        
        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 60px;
            right: 16px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .toast {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 10px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
            font-size: 13px;
            color: var(--text-primary);
            animation: toastIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(8px);
        }
        
        .toast.hiding {
            animation: toastOut 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }
        
        @keyframes toastIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes toastOut {
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }
        
        .toast svg {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
        }
        
        .toast.success {
            border-color: rgba(34, 197, 94, 0.3);
            color: var(--success);
        }
        
        .toast.error {
            border-color: rgba(239, 68, 68, 0.3);
            color: var(--error);
        }
        
        .toast.info {
            border-color: rgba(147, 51, 234, 0.3);
            color: var(--accent-hover);
        }
        
        /* Console Area */
        .console-container {
            flex: 1;
            position: relative;
            background: #000;
            overflow: hidden;
        }
        
        #screen {
            width: 100%;
            height: 100%;
        }
        
        /* Loading Overlay */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.95);
            z-index: 50;
            gap: 16px;
            transition: opacity 0.3s ease;
        }
        
        .overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--bg-elevated);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .overlay-title {
            font-size: 18px;
            font-weight: 600;
        }
        
        .overlay-subtitle {
            font-size: 14px;
            color: var(--text-muted);
        }
        
        .error-icon {
            width: 64px;
            height: 64px;
            color: var(--error);
        }
        
        /* Enhanced Footer */
        .footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 12px;
            background: linear-gradient(0deg, var(--bg-surface) 0%, rgba(18, 18, 26, 0.95) 100%);
            border-top: 1px solid var(--border);
            font-size: 11px;
            color: var(--text-muted);
            flex-shrink: 0;
            backdrop-filter: blur(12px);
        }
        
        .footer-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .footer-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .kbd {
            display: inline-flex;
            align-items: center;
            padding: 2px 6px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 4px;
            font-family: monospace;
            font-size: 10px;
        }
        
        .footer-item {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            background: var(--bg-elevated);
            border-radius: 4px;
        }
        
        /* Fullscreen Mode */
        body.fullscreen .toolbar,
        body.fullscreen .footer {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        body.fullscreen:hover .toolbar,
        body.fullscreen:hover .footer {
            opacity: 1;
            pointer-events: auto;
        }
        
        body.fullscreen .console-container {
            height: 100vh;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .toolbar {
                padding: 6px 8px;
            }
            
            .vm-name {
                display: none;
            }
            
            .btn .btn-label {
                display: none;
            }
            
            .btn:hover .btn-label {
                max-width: 0;
                margin-left: 0;
            }
            
            .toolbar-divider {
                margin: 0 4px;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Toolbar -->
        <div class="toolbar">
            <div class="toolbar-section">
                <div class="logo">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
                        <line x1="8" y1="21" x2="16" y2="21"/>
                        <line x1="12" y1="17" x2="12" y2="21"/>
                    </svg>
                    <span>Console</span>
                </div>
                <span class="vm-name" id="vmName">Loading...</span>
                <div class="status-badge connecting" id="statusBadge">
                    <span class="status-dot"></span>
                    <span id="statusText">Connecting</span>
                </div>
            </div>
            
            <div class="toolbar-section">
                <!-- VM Power Menu -->
                <div class="dropdown-container" id="vmMenuContainer">
                    <button class="btn" id="btnVmMenu" title="VM Actions">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="2" y="2" width="20" height="8" rx="2" ry="2"/>
                            <rect x="2" y="14" width="20" height="8" rx="2" ry="2"/>
                            <line x1="6" y1="6" x2="6.01" y2="6"/>
                            <line x1="6" y1="18" x2="6.01" y2="18"/>
                        </svg>
                        <span class="btn-label">VM</span>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:12px;height:12px;margin-left:4px;">
                            <polyline points="6 9 12 15 18 9"/>
                        </svg>
                    </button>
                    <div class="dropdown-menu" id="vmMenu">
                        <div class="dropdown-section-title">Power Actions</div>
                        <button class="dropdown-item success" id="btnPowerOn">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M18.36 6.64a9 9 0 1 1-12.73 0"/>
                                <line x1="12" y1="2" x2="12" y2="12"/>
                            </svg>
                            <span>Power On</span>
                        </button>
                        <button class="dropdown-item warning" id="btnShutdown">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M18.36 6.64a9 9 0 1 1-12.73 0"/>
                                <line x1="12" y1="2" x2="12" y2="12"/>
                            </svg>
                            <span>Shut Down Guest</span>
                        </button>
                        <button class="dropdown-item" id="btnRestart">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="23 4 23 10 17 10"/>
                                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                            </svg>
                            <span>Restart Guest</span>
                        </button>
                        <div class="dropdown-divider"></div>
                        <button class="dropdown-item danger" id="btnForcePowerOff">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="2" y="6" width="20" height="12" rx="2"/>
                                <line x1="6" y1="12" x2="18" y2="12"/>
                            </svg>
                            <span>Force Power Off</span>
                        </button>
                    </div>
                </div>
                
                <div class="toolbar-divider"></div>
                
                <!-- Ctrl+Alt+Del -->
                <button class="btn btn-warning" id="btnCtrlAltDel" title="Send Ctrl+Alt+Del">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="2" y="4" width="20" height="16" rx="2"/>
                        <path d="M6 8h4M14 8h4M6 12h12M10 16h4"/>
                    </svg>
                    <span class="btn-label">Ctrl+Alt+Del</span>
                </button>
                
                <!-- Clipboard -->
                <button class="btn btn-accent" id="btnClipboard" title="Paste from clipboard">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="8" y="2" width="8" height="4" rx="1" ry="1"/>
                        <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/>
                    </svg>
                    <span class="btn-label">Paste</span>
                </button>
                
                <div class="toolbar-divider"></div>
                
                <!-- Reconnect -->
                <button class="btn" id="btnReconnect" title="Reconnect to console">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="23 4 23 10 17 10"/>
                        <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                    </svg>
                    <span class="btn-label">Reconnect</span>
                </button>
                
                <!-- Quality Settings Dropdown -->
                <div class="dropdown-container" id="qualityMenuContainer">
                    <button class="btn" id="btnQuality" title="Quality Settings">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"/>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                        </svg>
                        <span class="btn-label">Quality</span>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:12px;height:12px;margin-left:4px;">
                            <polyline points="6 9 12 15 18 9"/>
                        </svg>
                    </button>
                    <div class="dropdown-menu" id="qualityMenu">
                        <div class="dropdown-section-title">Compression Quality</div>
                        <button class="dropdown-item quality-option" data-quality="auto">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 16v-4M12 8h.01"/>
                            </svg>
                            <span>Auto (Recommended)</span>
                            <span class="quality-check" style="margin-left:auto;display:none;">✓</span>
                        </button>
                        <button class="dropdown-item quality-option" data-quality="high">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2"/>
                                <circle cx="12" cy="12" r="4"/>
                            </svg>
                            <span>High Quality</span>
                            <span class="quality-check" style="margin-left:auto;display:none;">✓</span>
                        </button>
                        <button class="dropdown-item quality-option" data-quality="medium">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2"/>
                                <line x1="9" y1="9" x2="15" y2="15"/>
                                <line x1="15" y1="9" x2="9" y2="15"/>
                            </svg>
                            <span>Balanced</span>
                            <span class="quality-check" style="margin-left:auto;display:none;">✓</span>
                        </button>
                        <button class="dropdown-item quality-option" data-quality="low">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                            </svg>
                            <span>Low Bandwidth</span>
                            <span class="quality-check" style="margin-left:auto;display:none;">✓</span>
                        </button>
                        <div class="dropdown-divider"></div>
                        <div class="dropdown-section-title">Performance</div>
                        <button class="dropdown-item" id="btnToggleScale">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="15 3 21 3 21 9"/>
                                <polyline points="9 21 3 21 3 15"/>
                                <line x1="21" y1="3" x2="14" y2="10"/>
                                <line x1="3" y1="21" x2="10" y2="14"/>
                            </svg>
                            <span>Scale to Fit</span>
                            <span class="toggle-indicator" id="scaleIndicator" style="margin-left:auto;">ON</span>
                        </button>
                        <button class="dropdown-item" id="btnToggleLocalCursor">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M4 4l7.07 17 2.51-7.39L21 11.07z"/>
                            </svg>
                            <span>Show Local Cursor</span>
                            <span class="toggle-indicator" id="cursorIndicator" style="margin-left:auto;">ON</span>
                        </button>
                    </div>
                </div>
                
                <div class="toolbar-divider"></div>
                
                <!-- Fullscreen -->
                <button class="btn btn-success" id="btnFullscreen" title="Toggle fullscreen">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="iconFullscreen">
                        <polyline points="15 3 21 3 21 9"/>
                        <polyline points="9 21 3 21 3 15"/>
                        <line x1="21" y1="3" x2="14" y2="10"/>
                        <line x1="3" y1="21" x2="10" y2="14"/>
                    </svg>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="iconExitFullscreen" style="display:none">
                        <polyline points="4 14 10 14 10 20"/>
                        <polyline points="20 10 14 10 14 4"/>
                        <line x1="14" y1="10" x2="21" y2="3"/>
                        <line x1="3" y1="21" x2="10" y2="14"/>
                    </svg>
                    <span class="btn-label" id="fullscreenLabel">Fullscreen</span>
                </button>
                
                <div class="toolbar-divider"></div>
                
                <!-- Close Console -->
                <button class="btn btn-danger" id="btnClose" title="Close console (Escape)">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                    <span class="btn-label">Close</span>
                </button>
            </div>
        </div>
        
        <!-- Toast Container -->
        <div class="toast-container" id="toastContainer"></div>
        
        <!-- Console -->
        <div class="console-container" id="consoleContainer">
            <div id="screen"></div>
            
            <!-- Loading Overlay -->
            <div class="overlay" id="overlayLoading">
                <div class="spinner"></div>
                <div class="overlay-title" id="loadingTitle">Connecting to VM Console</div>
                <div class="overlay-subtitle" id="loadingSubtitle">Establishing secure connection...</div>
            </div>
            
            <!-- Error Overlay -->
            <div class="overlay hidden" id="overlayError">
                <svg class="error-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="12" y1="8" x2="12" y2="12"/>
                    <line x1="12" y1="16" x2="12.01" y2="16"/>
                </svg>
                <div class="overlay-title" id="errorTitle">Connection Failed</div>
                <div class="overlay-subtitle" id="errorMessage">Unable to connect to the VM console.</div>
                <button class="btn btn-primary" id="btnRetry">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="23 4 23 10 17 10"/>
                        <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                    </svg>
                    <span class="btn-label">Retry Connection</span>
                </button>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="footer">
            <div class="footer-left">
                <span><kbd class="kbd">Ctrl+Alt+Del</kbd> Send to VM</span>
                <span><kbd class="kbd">Esc</kbd> Exit fullscreen</span>
            </div>
            <div class="footer-right">
                <div class="footer-item" id="resolutionDisplay">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:12px;height:12px;">
                        <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
                        <line x1="8" y1="21" x2="16" y2="21"/>
                        <line x1="12" y1="17" x2="12" y2="21"/>
                    </svg>
                    <span id="resolution">-</span>
                </div>
                <div class="footer-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:12px;height:12px;">
                        <rect x="2" y="2" width="20" height="8" rx="2" ry="2"/>
                        <rect x="2" y="14" width="20" height="8" rx="2" ry="2"/>
                        <line x1="6" y1="6" x2="6.01" y2="6"/>
                        <line x1="6" y1="18" x2="6.01" y2="18"/>
                    </svg>
                    <span id="vmId">-</span>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import RFB from './core/rfb.js';

        // Parse URL parameters
        const params = new URLSearchParams(window.location.search);
        const vmId = params.get('vmId');
        const vmName = params.get('vmName') || 'Virtual Machine';
        const token = params.get('token');

        // API base URL - detect from current location
        const API_BASE = `${window.location.protocol}//${window.location.hostname}:8080/api`;

        // DOM elements
        const elVmName = document.getElementById('vmName');
        const elVmId = document.getElementById('vmId');
        const elStatusBadge = document.getElementById('statusBadge');
        const elStatusText = document.getElementById('statusText');
        const elResolution = document.getElementById('resolution');
        const elOverlayLoading = document.getElementById('overlayLoading');
        const elOverlayError = document.getElementById('overlayError');
        const elErrorTitle = document.getElementById('errorTitle');
        const elErrorMessage = document.getElementById('errorMessage');
        const elLoadingTitle = document.getElementById('loadingTitle');
        const elLoadingSubtitle = document.getElementById('loadingSubtitle');
        const elScreen = document.getElementById('screen');
        const elConsoleContainer = document.getElementById('consoleContainer');
        const elToastContainer = document.getElementById('toastContainer');
        
        // Track if this is a reconnection attempt
        let isReconnecting = false;
        
        // Buttons
        const btnCtrlAltDel = document.getElementById('btnCtrlAltDel');
        const btnClipboard = document.getElementById('btnClipboard');
        const btnFullscreen = document.getElementById('btnFullscreen');
        const btnReconnect = document.getElementById('btnReconnect');
        const btnRetry = document.getElementById('btnRetry');
        const btnClose = document.getElementById('btnClose');
        const btnVmMenu = document.getElementById('btnVmMenu');
        const vmMenu = document.getElementById('vmMenu');
        const vmMenuContainer = document.getElementById('vmMenuContainer');
        
        // Power buttons
        const btnPowerOn = document.getElementById('btnPowerOn');
        const btnShutdown = document.getElementById('btnShutdown');
        const btnRestart = document.getElementById('btnRestart');
        const btnForcePowerOff = document.getElementById('btnForcePowerOff');
        
        // Quality menu elements
        const btnQuality = document.getElementById('btnQuality');
        const qualityMenu = document.getElementById('qualityMenu');
        const qualityMenuContainer = document.getElementById('qualityMenuContainer');
        const qualityOptions = document.querySelectorAll('.quality-option');
        const btnToggleScale = document.getElementById('btnToggleScale');
        const btnToggleLocalCursor = document.getElementById('btnToggleLocalCursor');
        const scaleIndicator = document.getElementById('scaleIndicator');
        const cursorIndicator = document.getElementById('cursorIndicator');
        
        // Icons
        const iconFullscreen = document.getElementById('iconFullscreen');
        const iconExitFullscreen = document.getElementById('iconExitFullscreen');
        const fullscreenLabel = document.getElementById('fullscreenLabel');

        // Set VM info
        elVmName.textContent = vmName;
        elVmId.textContent = vmId ? vmId.slice(0, 8) + '...' : '-';

        // Validate VM ID
        if (!vmId) {
            showError('Invalid Request', 'No VM ID was provided in the URL.');
            throw new Error('No VM ID');
        }

        // RFB instance
        let rfb = null;

        // Toast notifications
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',
                error: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',
                info: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>'
            };
            
            toast.innerHTML = `${icons[type] || icons.info}<span>${message}</span>`;
            elToastContainer.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('hiding');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // VM Power Actions
        async function vmPowerAction(action) {
            const actionNames = {
                start: 'Power On',
                stop: 'Shut Down',
                reboot: 'Restart',
                force_stop: 'Force Power Off'
            };
            
            try {
                showToast(`Sending ${actionNames[action]}...`, 'info');
                
                const response = await fetch(`${API_BASE}/vms/${vmId}/${action}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    const error = await response.json().catch(() => ({}));
                    throw new Error(error.message || `Failed to ${action} VM`);
                }
                
                showToast(`${actionNames[action]} command sent successfully`, 'success');
                
                // Close menu
                vmMenu.classList.remove('show');
                
            } catch (err) {
                console.error('Power action failed:', err);
                showToast(`Failed: ${err.message}`, 'error');
            }
        }

        // Build WebSocket URL
        function getWebSocketUrl() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const host = window.location.hostname;
            const port = 8080;
            return `${protocol}//${host}:${port}/api/console/${vmId}/ws`;
        }

        // Update status
        function setStatus(status, text) {
            elStatusBadge.className = 'status-badge ' + status;
            elStatusText.textContent = text;
        }

        // Show error
        function showError(title, message) {
            elOverlayLoading.classList.add('hidden');
            elOverlayError.classList.remove('hidden');
            elErrorTitle.textContent = title;
            elErrorMessage.textContent = message;
            setStatus('disconnected', 'Disconnected');
        }

        // Connect to VNC
        function connect(reconnect = false) {
            // Track reconnection state for toast timing
            isReconnecting = reconnect;
            
            // Update overlay text based on connection type
            if (reconnect) {
                elLoadingTitle.textContent = 'Reconnecting to VM Console';
                elLoadingSubtitle.textContent = 'Re-establishing connection...';
            } else {
                elLoadingTitle.textContent = 'Connecting to VM Console';
                elLoadingSubtitle.textContent = 'Establishing secure connection...';
            }
            
            // Reset UI - show loading overlay
            elOverlayLoading.classList.remove('hidden');
            elOverlayError.classList.add('hidden');
            setStatus('connecting', reconnect ? 'Reconnecting' : 'Connecting');

            // Clean up previous connection
            if (rfb) {
                rfb.disconnect();
                rfb = null;
            }

            // Clear screen
            elScreen.innerHTML = '';

            try {
                const wsUrl = getWebSocketUrl();
                console.log('Connecting to:', wsUrl);

                rfb = new RFB(elScreen, wsUrl, {
                    credentials: token ? { password: token } : undefined,
                });

                // Configure RFB with stored settings
                rfb.scaleViewport = scaleViewport;
                rfb.resizeSession = true;
                rfb.showDotCursor = showLocalCursor;
                rfb.clipViewport = false;
                
                // Apply quality preset
                const preset = qualityPresets[currentQuality];
                if (preset) {
                    rfb.compressionLevel = preset.compressionLevel;
                    rfb.qualityLevel = preset.qualityLevel;
                }

                // Event: Connected
                rfb.addEventListener('connect', () => {
                    console.log('VNC Connected');
                    elOverlayLoading.classList.add('hidden');
                    setStatus('connected', 'Connected');
                    
                    // Show appropriate toast based on reconnection state
                    if (isReconnecting) {
                        showToast('Reconnected to VM console', 'success');
                    } else {
                        showToast('Connected to VM console', 'success');
                    }
                    
                    // Update resolution
                    updateResolution();
                });

                // Event: Disconnected
                rfb.addEventListener('disconnect', (e) => {
                    console.log('VNC Disconnected', e.detail);
                    if (!e.detail.clean) {
                        showError('Connection Lost', 'The connection to the VM was interrupted.');
                    } else {
                        showError('Disconnected', 'The console session has ended.');
                    }
                });

                // Event: Credentials required
                rfb.addEventListener('credentialsrequired', () => {
                    console.log('Credentials required');
                    const password = prompt('VNC Password:');
                    if (password) {
                        rfb.sendCredentials({ password });
                    } else {
                        rfb.disconnect();
                    }
                });

                // Event: Security failure
                rfb.addEventListener('securityfailure', (e) => {
                    console.error('Security failure', e.detail);
                    showError('Authentication Failed', e.detail.reason || 'Invalid credentials.');
                });

                // Event: Desktop name
                rfb.addEventListener('desktopname', (e) => {
                    console.log('Desktop name:', e.detail.name);
                });
                
                // Event: Clipboard from server (ServerCutText)
                rfb.addEventListener('clipboard', (e) => {
                    const text = e.detail.text;
                    if (text && navigator.clipboard && navigator.clipboard.writeText) {
                        navigator.clipboard.writeText(text)
                            .then(() => {
                                console.log('Clipboard synced from VM:', text.length, 'chars');
                                showToast('Clipboard synced from VM', 'info');
                            })
                            .catch(err => {
                                console.warn('Failed to sync clipboard from VM:', err);
                            });
                    }
                });

            } catch (err) {
                console.error('Connection error:', err);
                showError('Connection Error', err.message || 'Failed to establish connection.');
            }
        }

        // Update resolution display
        function updateResolution() {
            if (rfb && rfb._fbWidth && rfb._fbHeight) {
                elResolution.textContent = `${rfb._fbWidth}×${rfb._fbHeight}`;
            }
        }

        // Ctrl+Alt+Del
        btnCtrlAltDel.addEventListener('click', () => {
            if (rfb) {
                rfb.sendCtrlAltDel();
                showToast('Ctrl+Alt+Del sent', 'info');
            }
        });

        // Clipboard paste - Enhanced with better feedback
        btnClipboard.addEventListener('click', async () => {
            try {
                // First try the modern Clipboard API
                if (navigator.clipboard && navigator.clipboard.readText) {
                    const text = await navigator.clipboard.readText();
                    if (rfb && text) {
                        rfb.clipboardPasteFrom(text);
                        showToast(`Pasted ${text.length} characters`, 'success');
                    } else if (!text) {
                        showToast('Clipboard is empty', 'info');
                    }
                } else {
                    // Fallback for older browsers - show a prompt
                    const text = prompt('Paste text to send to VM:');
                    if (rfb && text) {
                        rfb.clipboardPasteFrom(text);
                        showToast(`Pasted ${text.length} characters`, 'success');
                    }
                }
            } catch (err) {
                console.warn('Clipboard access denied:', err);
                // Fallback to prompt
                const text = prompt('Clipboard access denied. Paste text here:');
                if (rfb && text) {
                    rfb.clipboardPasteFrom(text);
                    showToast(`Pasted ${text.length} characters`, 'success');
                }
            }
        });

        // Fullscreen toggle - Fixed to use the app container
        btnFullscreen.addEventListener('click', async () => {
            try {
                if (!document.fullscreenElement) {
                    // Request fullscreen on the app container for better control
                    await document.getElementById('app').requestFullscreen();
                } else {
                    await document.exitFullscreen();
                }
            } catch (err) {
                console.error('Fullscreen error:', err);
                showToast('Fullscreen not supported', 'error');
            }
        });

        document.addEventListener('fullscreenchange', () => {
            const isFullscreen = !!document.fullscreenElement;
            document.body.classList.toggle('fullscreen', isFullscreen);
            iconFullscreen.style.display = isFullscreen ? 'none' : 'block';
            iconExitFullscreen.style.display = isFullscreen ? 'block' : 'none';
            fullscreenLabel.textContent = isFullscreen ? 'Exit Fullscreen' : 'Fullscreen';
        });

        // Reconnect button - shows loading overlay, toast comes after connection succeeds
        btnReconnect.addEventListener('click', () => {
            connect(true);
        });

        // Close button - notify parent window to close the modal
        btnClose.addEventListener('click', () => {
            // Disconnect VNC first
            if (rfb) {
                rfb.disconnect();
            }
            // Notify parent window (React) to close the modal
            if (window.parent && window.parent !== window) {
                window.parent.postMessage({ type: 'closeConsole' }, '*');
            }
            // If opened in a new tab/window, just close it
            if (window.opener || window.parent === window) {
                window.close();
            }
        });

        // Retry button (on error overlay)
        btnRetry.addEventListener('click', () => {
            connect(true);
        });

        // VM Menu toggle (click-based for touch devices)
        btnVmMenu.addEventListener('click', (e) => {
            e.stopPropagation();
            vmMenu.classList.toggle('show');
        });

        // Close menu when clicking outside
        document.addEventListener('click', (e) => {
            if (!vmMenuContainer.contains(e.target)) {
                vmMenu.classList.remove('show');
            }
        });

        // Power action buttons
        btnPowerOn.addEventListener('click', () => vmPowerAction('start'));
        btnShutdown.addEventListener('click', () => vmPowerAction('stop'));
        btnRestart.addEventListener('click', () => vmPowerAction('reboot'));
        btnForcePowerOff.addEventListener('click', () => vmPowerAction('force_stop'));
        
        // Quality Settings
        let currentQuality = localStorage.getItem('consoleQuality') || 'auto';
        let scaleViewport = localStorage.getItem('consoleScale') !== 'false';
        let showLocalCursor = localStorage.getItem('consoleCursor') !== 'false';
        
        // Quality presets (compression level and JPEG quality)
        const qualityPresets = {
            auto: { compressionLevel: 2, qualityLevel: 6 },  // Balanced defaults
            high: { compressionLevel: 0, qualityLevel: 9 },  // Best quality, no compression
            medium: { compressionLevel: 5, qualityLevel: 5 }, // Medium compression
            low: { compressionLevel: 9, qualityLevel: 2 }    // Maximum compression for slow networks
        };
        
        // Initialize quality menu UI
        function updateQualityUI() {
            qualityOptions.forEach(opt => {
                const isActive = opt.dataset.quality === currentQuality;
                opt.classList.toggle('active', isActive);
            });
            
            scaleIndicator.textContent = scaleViewport ? 'ON' : 'OFF';
            scaleIndicator.classList.toggle('off', !scaleViewport);
            
            cursorIndicator.textContent = showLocalCursor ? 'ON' : 'OFF';
            cursorIndicator.classList.toggle('off', !showLocalCursor);
        }
        
        // Apply quality settings to RFB
        function applyQualitySettings() {
            if (!rfb) return;
            
            const preset = qualityPresets[currentQuality];
            if (preset) {
                rfb.compressionLevel = preset.compressionLevel;
                rfb.qualityLevel = preset.qualityLevel;
            }
            
            rfb.scaleViewport = scaleViewport;
            rfb.showDotCursor = showLocalCursor;
        }
        
        // Quality option click handlers
        qualityOptions.forEach(opt => {
            opt.addEventListener('click', () => {
                currentQuality = opt.dataset.quality;
                localStorage.setItem('consoleQuality', currentQuality);
                updateQualityUI();
                applyQualitySettings();
                qualityMenu.classList.remove('show');
                
                const qualityNames = { auto: 'Auto', high: 'High Quality', medium: 'Balanced', low: 'Low Bandwidth' };
                showToast(`Quality set to ${qualityNames[currentQuality]}`, 'success');
            });
        });
        
        // Scale toggle
        btnToggleScale.addEventListener('click', () => {
            scaleViewport = !scaleViewport;
            localStorage.setItem('consoleScale', scaleViewport);
            updateQualityUI();
            applyQualitySettings();
            showToast(`Scale to Fit ${scaleViewport ? 'enabled' : 'disabled'}`, 'info');
        });
        
        // Local cursor toggle
        btnToggleLocalCursor.addEventListener('click', () => {
            showLocalCursor = !showLocalCursor;
            localStorage.setItem('consoleCursor', showLocalCursor);
            updateQualityUI();
            applyQualitySettings();
            showToast(`Local cursor ${showLocalCursor ? 'visible' : 'hidden'}`, 'info');
        });
        
        // Quality menu toggle (click-based)
        btnQuality.addEventListener('click', (e) => {
            e.stopPropagation();
            qualityMenu.classList.toggle('show');
            // Close VM menu if open
            vmMenu.classList.remove('show');
        });
        
        // Close quality menu when clicking outside
        document.addEventListener('click', (e) => {
            if (!qualityMenuContainer.contains(e.target)) {
                qualityMenu.classList.remove('show');
            }
        });
        
        // Initialize quality UI on load
        updateQualityUI();
        
        // Bidirectional Clipboard Sync
        // Poll local clipboard for changes and send to VM
        let lastClipboardText = '';
        let clipboardSyncEnabled = localStorage.getItem('clipboardSync') !== 'false';
        
        async function syncClipboardToVM() {
            if (!clipboardSyncEnabled || !rfb) return;
            
            try {
                if (navigator.clipboard && navigator.clipboard.readText) {
                    // Check if document has focus before reading clipboard
                    if (document.hasFocus()) {
                        const text = await navigator.clipboard.readText();
                        if (text && text !== lastClipboardText) {
                            lastClipboardText = text;
                            rfb.clipboardPasteFrom(text);
                            console.log('Clipboard synced to VM:', text.length, 'chars');
                        }
                    }
                }
            } catch (err) {
                // Silently fail - clipboard access may not be allowed
                console.debug('Clipboard read failed:', err.message);
            }
        }
        
        // Start clipboard polling when connected (every 500ms)
        let clipboardPollInterval = null;
        
        function startClipboardSync() {
            if (clipboardPollInterval) clearInterval(clipboardPollInterval);
            if (clipboardSyncEnabled) {
                clipboardPollInterval = setInterval(syncClipboardToVM, 500);
            }
        }
        
        function stopClipboardSync() {
            if (clipboardPollInterval) {
                clearInterval(clipboardPollInterval);
                clipboardPollInterval = null;
            }
        }
        
        // Handle focus/blur to optimize clipboard polling
        window.addEventListener('focus', () => {
            if (rfb && clipboardSyncEnabled) {
                startClipboardSync();
            }
        });
        
        window.addEventListener('blur', () => {
            stopClipboardSync();
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Ctrl+Alt+Del shortcut
            if (e.ctrlKey && e.altKey && e.key === 'Delete') {
                e.preventDefault();
                if (rfb) {
                    rfb.sendCtrlAltDel();
                    showToast('Ctrl+Alt+Del sent', 'info');
                }
            }
            
            // Escape to exit fullscreen (browser handles this but we track it)
            if (e.key === 'Escape' && document.fullscreenElement) {
                // Browser will handle exiting fullscreen
            }
        });

        // Post message API for parent window communication
        window.addEventListener('message', (e) => {
            if (e.data.type === 'ctrlAltDel' && rfb) {
                rfb.sendCtrlAltDel();
            } else if (e.data.type === 'disconnect' && rfb) {
                rfb.disconnect();
            } else if (e.data.type === 'reconnect') {
                connect(true);
            } else if (e.data.type === 'powerAction' && e.data.action) {
                vmPowerAction(e.data.action);
            }
        });

        // Start connection
        connect();
    </script>
</body>
</html>
