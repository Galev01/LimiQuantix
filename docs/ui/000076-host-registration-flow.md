# 000076 - Host Registration Flow

This document describes the revised host registration flow for Quantix-vDC.

## Overview

The host registration flow has been redesigned to provide better security and resource visibility:

1. **Token is generated by the host** - Not by the vDC
2. **Token expires after 1 hour** - Short-lived for security
3. **Host shares all resources** - Local storage, NFS mounts, iSCSI targets
4. **Host must join a specific cluster** - Cannot join vDC without cluster assignment

## Registration Flow Diagram

```
┌─────────────────────┐                    ┌─────────────────────┐
│   Quantix-OS Host   │                    │    Quantix-vDC      │
│   (Console/UI)      │                    │    (Admin UI)       │
│                     │                    │                     │
│  1. Press F4        │                    │                     │
│  2. Generate Token  │                    │                     │
│     (valid 1hr)     │                    │                     │
│                     │                    │                     │
│  Token displayed:   │                    │  4. Click "Add Host"│
│  QUANTIX-XXXX-XXXX  │ ─────────────────► │  5. Enter Host IP   │
│                     │   Admin copies     │  6. Enter Token     │
│                     │                    │  7. Select Cluster  │
│                     │                    │  8. Click Connect   │
│                     │                    │                     │
│                     │ ◄───────────────── │  vDC calls:         │
│                     │   Validate token   │  /api/v1/registration│
│                     │   + discovery      │  /token + /discovery│
│                     │                    │                     │
│                     │                    │  9. Show resources  │
│                     │                    │ 10. Confirm add     │
│                     │                    │                     │
│  Host joins cluster │ ◄───────────────── │  vDC registers node │
│  Configuration set  │                    │                     │
└─────────────────────┘                    └─────────────────────┘
```

## API Endpoints

### Node Daemon (Host-side)

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/api/v1/registration/token` | POST | Generate a new 1-hour registration token |
| `/api/v1/registration/token` | GET | Get current token (if still valid) |
| `/api/v1/registration/discovery` | GET | Get full hardware inventory |

### Control Plane (vDC-side)

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/api/nodes/discover` | POST | Connect to host, validate token, fetch resources |
| `/api/nodes/register` | POST | Register host with cluster |

## Token Format

```
QUANTIX-XXXX-XXXX-XXXX
```

- 12 random bytes encoded as Base32
- Formatted with dashes for readability
- Valid for exactly 1 hour from generation
- Single-use (invalidated after successful registration)

## Discovery Response

When vDC connects to a host, it receives:

```json
{
  "hostname": "hypervisor-01",
  "managementIp": "192.168.1.100",
  "cpu": {
    "model": "AMD EPYC 7763",
    "cores": 64,
    "threads": 128,
    "sockets": 2
  },
  "memory": {
    "totalBytes": 549755813888,
    "availableBytes": 536870912000
  },
  "storage": {
    "local": [
      {
        "name": "nvme0n1",
        "diskType": "NVMe",
        "sizeBytes": 1073741824000
      }
    ],
    "nfs": [
      {
        "mountPoint": "/mnt/storage",
        "server": "nas.local",
        "exportPath": "/share",
        "sizeBytes": 5368709120000
      }
    ],
    "iscsi": [
      {
        "targetIqn": "iqn.2024.com.storage:lun1",
        "devicePath": "/dev/sdb",
        "sizeBytes": 2147483648000
      }
    ]
  },
  "network": [
    {
      "name": "eth0",
      "macAddress": "00:11:22:33:44:55",
      "speedMbps": 25000
    }
  ],
  "gpus": [
    {
      "name": "NVIDIA A100",
      "vendor": "NVIDIA"
    }
  ]
}
```

## Cluster Assignment

Every host must be assigned to a cluster. The cluster determines:

- Resource pooling and scheduling
- High availability groups
- Network policies
- Storage policies

Available clusters are shown in a dropdown during the add host flow.

## Security Considerations

1. **Token lifetime**: 1 hour maximum to minimize exposure window
2. **Token storage**: Only stored on the host, not in vDC database
3. **TLS**: All communication uses HTTPS
4. **Single use**: Token is invalidated after successful use
5. **Audit logging**: All registration attempts are logged

## Implementation Files

### Node Daemon (Rust)
- `agent/limiquantix-node/src/http_server.rs` - Token generation and discovery endpoints

### Control Plane (Go)
- `backend/internal/server/host_registration_handler.go` - Discovery and registration handlers

### Frontend (React)
- `frontend/src/components/host/AddHostModal.tsx` - Add host wizard UI

## Usage Instructions

### Generating a Token (Host Console)

1. Boot the server with Quantix-OS
2. In the TUI console, press **F4** to open cluster settings
3. Select **"Generate Registration Token"**
4. Copy the displayed token (valid for 1 hour)

### Adding the Host (vDC UI)

1. Navigate to **Hosts** page
2. Click **"Add Host"** button
3. Enter the host's IP address (e.g., `192.168.1.100`)
4. Paste the registration token
5. Select the target cluster
6. Click **"Connect & Discover"**
7. Review the discovered resources
8. Click **"Add Host to Cluster"** to confirm

## Error Handling

| Error | Cause | Solution |
|-------|-------|----------|
| "Invalid or expired token" | Token older than 1 hour | Generate new token on host |
| "Failed to connect to host" | Network/firewall issue | Check port 8443 is open |
| "Cluster ID is required" | No cluster selected | Select a cluster in the dropdown |
| "Host already registered" | Duplicate registration | Remove existing host first |
