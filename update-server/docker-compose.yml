# =============================================================================
# Quantix Update Server - Docker Compose
# =============================================================================
# Local development deployment for the OTA update server with Admin UI.
#
# Usage:
#   docker-compose up -d        # Start server
#   docker-compose logs -f      # View logs
#   docker-compose down         # Stop server
#
# The server will be available at: http://localhost:9000
# Admin UI is accessible at the same URL.
# =============================================================================

services:
  update-server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: quantix-update-server
    ports:
      - "9000:9000"
    volumes:
      # Persist releases directory
      - ./releases:/data/releases
      # Mount the workspace for git operations and builds
      - ..:/workspace:rw
    environment:
      - RELEASE_DIR=/data/releases
      - LISTEN_ADDR=0.0.0.0:9000
      # Change this token for production!
      - PUBLISH_TOKEN=${PUBLISH_TOKEN:-dev-token}
      # Git repo path inside container
      - GIT_REPO_PATH=/workspace
      # UI path (built into container)
      - UI_PATH=/app/ui/dist
      - TZ=UTC
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9000/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# =============================================================================
# Usage Notes
# =============================================================================
# 
# Admin UI:
#   Open http://localhost:9000 in your browser to access the admin interface.
#   You can:
#   - View all releases
#   - Pull latest code from git
#   - Build and publish new releases
#   - Delete old releases
#
# API Endpoints:
#   GET  /api/v1/health                     - Health check
#   GET  /api/v1/channels                   - List channels
#   GET  /api/v1/{product}/manifest         - Latest manifest
#   GET  /api/v1/{product}/releases         - List releases
#   POST /api/v1/{product}/publish          - Publish release (auth required)
#   POST /api/v1/admin/git-pull             - Pull latest code (auth required)
#   POST /api/v1/admin/build                - Trigger build (auth required)
#
# To publish an update manually:
#   curl -X POST http://localhost:9000/api/v1/quantix-os/publish \
#     -H "Authorization: Bearer dev-token" \
#     -F "manifest=@manifest.json" \
#     -F "qx-node=@qx-node.tar.zst"
#
# =============================================================================
