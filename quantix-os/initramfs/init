#!/bin/sh
# =============================================================================
# Quantix-OS Init Script (initramfs)
# =============================================================================
# This script runs from initramfs and sets up the root filesystem.
# Supports:
#   - Live boot from ISO/USB (boot=live)
#   - Installed system boot (root=LABEL=QUANTIX-A)
#   - A/B partitioning with automatic rollback
# =============================================================================

# VERY FIRST THING: Try to get output working
# This runs before anything else to ensure we can see messages

# Mount essential filesystems
/bin/busybox mount -t proc none /proc 2>/dev/null || mount -t proc none /proc
/bin/busybox mount -t sysfs none /sys 2>/dev/null || mount -t sysfs none /sys
/bin/busybox mount -t devtmpfs none /dev 2>/dev/null || mount -t devtmpfs none /dev

# Enable ALL kernel messages to console
echo 8 > /proc/sys/kernel/printk 2>/dev/null

# Create essential device nodes if devtmpfs didn't
[ -c /dev/console ] || mknod -m 622 /dev/console c 5 1 2>/dev/null
[ -c /dev/null ] || mknod -m 666 /dev/null c 1 3 2>/dev/null
[ -c /dev/tty ] || mknod -m 666 /dev/tty c 5 0 2>/dev/null
[ -c /dev/tty0 ] || mknod -m 666 /dev/tty0 c 4 0 2>/dev/null
[ -c /dev/tty1 ] || mknod -m 666 /dev/tty1 c 4 1 2>/dev/null

# Redirect output to console
exec 0</dev/console
exec 1>/dev/console
exec 2>/dev/console

echo ""
echo "============================================================"
echo "     QUANTIX-OS INITRAMFS STARTING"
echo "============================================================"
echo ""
echo "[INIT] Script is running!"
echo "[INIT] Date: $(date 2>/dev/null || echo 'unknown')"
echo "[INIT] Shell: $0"
echo "[INIT] PID: $$"
echo ""

# =============================================================================
# CRITICAL: Load kernel modules for block devices FIRST
# =============================================================================
echo "[INIT] Loading kernel modules..."

# Find kernel version
KVER=""
if [ -d /lib/modules ]; then
    KVER=$(ls /lib/modules 2>/dev/null | head -1)
    echo "[INIT] Kernel modules directory: /lib/modules/$KVER"
    ls -la /lib/modules/ 2>/dev/null
else
    echo "[INIT] WARNING: No /lib/modules directory!"
fi

if [ -n "$KVER" ] && [ -d "/lib/modules/$KVER" ]; then
    # SCSI subsystem (MUST load first - other drivers depend on it)
    echo "[INIT] Loading SCSI subsystem..."
    for mod in scsi_mod sd_mod sr_mod; do
        modprobe $mod 2>/dev/null && echo "[INIT]   ✓ $mod" || echo "[INIT]   - $mod (built-in?)"
    done
    
    # USB drivers (for USB boot)
    echo "[INIT] Loading USB drivers..."
    for mod in usbcore usb_common xhci_hcd xhci_pci ehci_hcd ehci_pci uhci_hcd usb_storage uas; do
        modprobe $mod 2>/dev/null && echo "[INIT]   ✓ $mod" || true
    done
    
    # SATA/AHCI drivers
    echo "[INIT] Loading SATA/AHCI drivers..."
    for mod in libata ahci ata_piix ata_generic; do
        modprobe $mod 2>/dev/null && echo "[INIT]   ✓ $mod" || true
    done
    
    # NVMe drivers
    echo "[INIT] Loading NVMe drivers..."
    for mod in nvme nvme_core; do
        modprobe $mod 2>/dev/null && echo "[INIT]   ✓ $mod" || true
    done
    
    # VirtIO drivers (for QEMU/KVM)
    echo "[INIT] Loading VirtIO drivers..."
    for mod in virtio virtio_ring virtio_pci virtio_blk virtio_scsi virtio_net; do
        modprobe $mod 2>/dev/null && echo "[INIT]   ✓ $mod" || true
    done
    
    # Filesystem drivers
    echo "[INIT] Loading filesystem drivers..."
    for mod in loop squashfs overlay isofs iso9660 vfat fat ext4 xfs; do
        modprobe $mod 2>/dev/null && echo "[INIT]   ✓ $mod" || true
    done
    
    # CD-ROM driver
    echo "[INIT] Loading CD-ROM driver..."
    modprobe cdrom 2>/dev/null && echo "[INIT]   ✓ cdrom" || true
    
    # Video drivers (optional, for display)
    echo "[INIT] Loading video drivers..."
    for mod in drm drm_kms_helper i915 amdgpu nouveau; do
        modprobe $mod 2>/dev/null && echo "[INIT]   ✓ $mod" || true
    done
else
    echo "[INIT] WARNING: No kernel modules available!"
    echo "[INIT] Block devices may not be detected."
fi

# Rescan devices after loading modules
echo "[INIT] Rescanning devices..."
mdev -s 2>/dev/null || true
sleep 1
mdev -s 2>/dev/null || true

echo "[INIT] Module loading complete"

# Parse kernel command line
echo "[INIT] Parsing kernel command line..."
echo "[INIT] cmdline: $(cat /proc/cmdline)"

LIVE_BOOT=""
TORAM=""
SYSTEM_LABEL=""
CONFIG_LABEL="QUANTIX-CFG"
DATA_LABEL="QUANTIX-DATA"
INSTALL_MODE=""
DEBUG_MODE=""
BREAK_POINT=""

for param in $(cat /proc/cmdline); do
    case $param in
        boot=live)
            LIVE_BOOT="1"
            echo "[INIT]   Found: boot=live"
            ;;
        toram)
            TORAM="1"
            echo "[INIT]   Found: toram"
            ;;
        root=LABEL=*)
            SYSTEM_LABEL="${param#root=LABEL=}"
            echo "[INIT]   Found: root=LABEL=$SYSTEM_LABEL"
            ;;
        quantix.config=LABEL=*)
            CONFIG_LABEL="${param#quantix.config=LABEL=}"
            ;;
        quantix.data=LABEL=*)
            DATA_LABEL="${param#quantix.data=LABEL=}"
            ;;
        quantix.install=*)
            INSTALL_MODE="1"
            echo "[INIT]   Found: install mode"
            ;;
        debug)
            DEBUG_MODE="1"
            echo "[INIT]   Found: debug mode"
            ;;
        break=*)
            BREAK_POINT="${param#break=}"
            echo "[INIT]   Found: break=$BREAK_POINT"
            ;;
    esac
done

echo ""
echo "[INIT] Parsed configuration:"
echo "[INIT]   LIVE_BOOT=$LIVE_BOOT"
echo "[INIT]   TORAM=$TORAM"  
echo "[INIT]   DEBUG_MODE=$DEBUG_MODE"
echo "[INIT]   SYSTEM_LABEL=$SYSTEM_LABEL"
echo "[INIT]   BREAK_POINT=$BREAK_POINT"
echo ""

# Debug breakpoint - drop to shell before mounting
if [ "$BREAK_POINT" = "premount" ]; then
    echo ""
    echo "============================================================"
    echo "  DEBUG BREAKPOINT: premount"
    echo "  Dropping to shell for manual debugging."
    echo "  Type 'exit' to continue boot process."
    echo "============================================================"
    echo ""
    echo "Useful commands:"
    echo "  cat /proc/cmdline    - see kernel parameters"
    echo "  ls /dev/             - see available devices"
    echo "  blkid                - see block device labels"
    echo "  ls /                 - see initramfs contents"
    echo "  cat /init            - see this init script"
    echo ""
    /bin/sh
    echo "[INIT] Continuing boot after debug shell..."
fi

# Wait for devices to settle
echo "[INIT] Waiting for devices..."
sleep 3

# Scan for new devices
echo "[INIT] Scanning for block devices..."
for i in 1 2 3; do
    mdev -s 2>/dev/null || true
    sleep 1
done

# =============================================================================
# LIVE BOOT MODE (from ISO/USB)
# =============================================================================
if [ -n "$LIVE_BOOT" ]; then
    echo "[INIT] Live boot mode detected"
    
    # Find the boot media (CD-ROM or USB)
    BOOT_MEDIA=""
    SQUASHFS_PATH=""
    
    # Try CD-ROM devices first
    for dev in /dev/sr0 /dev/sr1 /dev/cdrom; do
        if [ -b "$dev" ]; then
            echo "[INIT] Trying CD-ROM: $dev"
            mkdir -p /mnt/cdrom
            if mount -t iso9660 -o ro "$dev" /mnt/cdrom 2>/dev/null; then
                if [ -f "/mnt/cdrom/quantix/system.squashfs" ]; then
                    BOOT_MEDIA="$dev"
                    SQUASHFS_PATH="/mnt/cdrom/quantix/system.squashfs"
                    echo "[INIT] Found squashfs on CD-ROM: $dev"
                    break
                fi
                umount /mnt/cdrom 2>/dev/null
            fi
        fi
    done
    
    # Try USB/disk devices if CD-ROM not found
    if [ -z "$SQUASHFS_PATH" ]; then
        for dev in /dev/sd[a-z] /dev/sd[a-z][0-9] /dev/nvme[0-9]n[0-9]p[0-9]; do
            if [ -b "$dev" ]; then
                echo "[INIT] Trying device: $dev"
                mkdir -p /mnt/usb
                # Try ISO9660 first (for USB with ISO written via dd)
                if mount -t iso9660 -o ro "$dev" /mnt/usb 2>/dev/null || \
                   mount -t vfat -o ro "$dev" /mnt/usb 2>/dev/null || \
                   mount -t ext4 -o ro "$dev" /mnt/usb 2>/dev/null; then
                    if [ -f "/mnt/usb/quantix/system.squashfs" ]; then
                        BOOT_MEDIA="$dev"
                        SQUASHFS_PATH="/mnt/usb/quantix/system.squashfs"
                        # Remount at /mnt/cdrom for consistency
                        umount /mnt/usb
                        mount -o ro "$dev" /mnt/cdrom 2>/dev/null
                        SQUASHFS_PATH="/mnt/cdrom/quantix/system.squashfs"
                        echo "[INIT] Found squashfs on USB: $dev"
                        break
                    fi
                    umount /mnt/usb 2>/dev/null
                fi
            fi
        done
    fi
    
    if [ -z "$SQUASHFS_PATH" ]; then
        echo "[ERROR] Could not find Quantix-OS boot media!"
        echo "[ERROR] Available block devices:"
        ls -la /dev/sd* /dev/sr* /dev/nvme* 2>/dev/null || echo "  (none found)"
        echo ""
        echo "[ERROR] Trying blkid:"
        blkid 2>/dev/null || echo "  (blkid not available)"
        echo ""
        echo "[ERROR] Dropping to emergency shell..."
        exec /bin/sh
    fi
    
    echo "[INIT] Using squashfs: $SQUASHFS_PATH"
    
    # Copy squashfs to RAM if requested
    if [ -n "$TORAM" ]; then
        echo "[INIT] Copying system to RAM (this may take a moment)..."
        mkdir -p /mnt/toram
        mount -t tmpfs -o size=80% tmpfs /mnt/toram
        cp "$SQUASHFS_PATH" /mnt/toram/system.squashfs
        SQUASHFS_PATH="/mnt/toram/system.squashfs"
        # Unmount boot media - no longer needed
        umount /mnt/cdrom 2>/dev/null || true
        echo "[INIT] System loaded to RAM"
    fi
    
    # Mount squashfs
    echo "[INIT] Mounting system image..."
    mkdir -p /mnt/lower
    mount -t squashfs -o ro "$SQUASHFS_PATH" /mnt/lower
    if [ $? -ne 0 ]; then
        echo "[ERROR] Failed to mount squashfs: $SQUASHFS_PATH"
        exec /bin/sh
    fi
    
    # Create tmpfs overlay for writable root
    echo "[INIT] Creating overlay filesystem..."
    mkdir -p /mnt/upper /mnt/work /mnt/merged
    mount -t tmpfs -o size=512M tmpfs /mnt/upper
    mkdir -p /mnt/upper/data /mnt/upper/work
    
    mount -t overlay overlay \
        -o lowerdir=/mnt/lower,upperdir=/mnt/upper/data,workdir=/mnt/upper/work \
        /mnt/merged
    if [ $? -ne 0 ]; then
        echo "[ERROR] Failed to create overlay filesystem"
        exec /bin/sh
    fi
    
    # Create required directories
    mkdir -p /mnt/merged/run
    mkdir -p /mnt/merged/tmp
    mkdir -p /mnt/merged/var/log
    mkdir -p /mnt/merged/mnt/cdrom
    
    # Keep boot media mounted if not using toram
    if [ -z "$TORAM" ] && [ -d "/mnt/cdrom" ]; then
        mount --move /mnt/cdrom /mnt/merged/mnt/cdrom 2>/dev/null || true
    fi
    
    # Check if installer mode
    if [ -n "$INSTALL_MODE" ]; then
        echo "[INIT] Installer mode - will launch installer after boot"
        touch /mnt/merged/tmp/.quantix_install_mode
    fi
    
    # Switch to new root
    echo "[INIT] Switching to Quantix-OS Live..."
    echo ""
    
    # Clean up
    umount /proc 2>/dev/null
    umount /sys 2>/dev/null
    umount /dev 2>/dev/null
    
    cd /mnt/merged
    pivot_root . mnt/initramfs 2>/dev/null || {
        # Fallback if pivot_root fails
        exec switch_root /mnt/merged /sbin/init
    }
    
    # Execute init
    exec /sbin/init
    
    # Fallback
    echo "[ERROR] Failed to start init!"
    exec /bin/sh
fi

# =============================================================================
# INSTALLED SYSTEM BOOT MODE
# =============================================================================

# Default to System A if not specified
[ -z "$SYSTEM_LABEL" ] && SYSTEM_LABEL="QUANTIX-A"

echo "[INIT] Installed system boot mode"
echo "[INIT] Boot configuration:"
echo "       System: ${SYSTEM_LABEL}"
echo "       Config: ${CONFIG_LABEL}"
echo "       Data:   ${DATA_LABEL}"

# Find and mount system partition
echo "[INIT] Mounting system partition..."
SYSTEM_DEV=$(findfs LABEL="${SYSTEM_LABEL}" 2>/dev/null)

if [ -z "$SYSTEM_DEV" ]; then
    echo "[ERROR] System partition not found: ${SYSTEM_LABEL}"
    echo "[ERROR] Available partitions:"
    blkid 2>/dev/null || ls -la /dev/sd* /dev/nvme* 2>/dev/null
    echo ""
    echo "[ERROR] Dropping to emergency shell..."
    exec /bin/sh
fi

mkdir -p /mnt/system
mount -t ext4 -o ro "$SYSTEM_DEV" /mnt/system
if [ $? -ne 0 ]; then
    echo "[ERROR] Failed to mount system partition: ${SYSTEM_DEV}"
    exec /bin/sh
fi

# Find squashfs
echo "[INIT] Locating system image..."
SQUASHFS_PATH=""
for path in \
    "/mnt/system/quantix/system.squashfs" \
    "/mnt/system/system.squashfs" \
    "/mnt/system/boot/system.squashfs"; do
    if [ -f "$path" ]; then
        SQUASHFS_PATH="$path"
        break
    fi
done

if [ -z "$SQUASHFS_PATH" ]; then
    # Try to find any squashfs
    SQUASHFS_PATH=$(find /mnt/system -name "system*.squashfs" 2>/dev/null | head -1)
fi

if [ -z "$SQUASHFS_PATH" ] || [ ! -f "$SQUASHFS_PATH" ]; then
    echo "[ERROR] System image not found!"
    echo "[ERROR] Contents of /mnt/system:"
    ls -la /mnt/system/
    exec /bin/sh
fi

echo "[INIT] Found system image: ${SQUASHFS_PATH}"

# Mount squashfs
echo "[INIT] Mounting system image..."
mkdir -p /mnt/lower
mount -t squashfs -o ro "$SQUASHFS_PATH" /mnt/lower
if [ $? -ne 0 ]; then
    echo "[ERROR] Failed to mount squashfs"
    exec /bin/sh
fi

# Create tmpfs for overlay upper layer
echo "[INIT] Creating overlay filesystem..."
mkdir -p /mnt/upper /mnt/work /mnt/merged
mount -t tmpfs -o size=512M tmpfs /mnt/upper
mkdir -p /mnt/upper/data /mnt/upper/work

# Create overlay
mount -t overlay overlay \
    -o lowerdir=/mnt/lower,upperdir=/mnt/upper/data,workdir=/mnt/upper/work \
    /mnt/merged
if [ $? -ne 0 ]; then
    echo "[ERROR] Failed to create overlay filesystem"
    exec /bin/sh
fi

# Mount config partition
echo "[INIT] Mounting config partition..."
CONFIG_DEV=$(findfs LABEL="${CONFIG_LABEL}" 2>/dev/null)
if [ -n "$CONFIG_DEV" ]; then
    mkdir -p /mnt/merged/quantix
    mount -t ext4 -o noatime "$CONFIG_DEV" /mnt/merged/quantix
    if [ $? -eq 0 ]; then
        echo "[INIT] Config partition mounted"
    else
        echo "[WARN] Failed to mount config partition"
    fi
else
    echo "[WARN] Config partition not found"
fi

# Mount data partition
echo "[INIT] Mounting data partition..."
DATA_DEV=$(findfs LABEL="${DATA_LABEL}" 2>/dev/null)
if [ -n "$DATA_DEV" ]; then
    mkdir -p /mnt/merged/data
    mount -t xfs -o noatime "$DATA_DEV" /mnt/merged/data 2>/dev/null || \
    mount -t ext4 -o noatime "$DATA_DEV" /mnt/merged/data 2>/dev/null
    if [ $? -eq 0 ]; then
        echo "[INIT] Data partition mounted"
    else
        echo "[WARN] Failed to mount data partition"
    fi
else
    echo "[WARN] Data partition not found"
fi

# Move system mount for later access
echo "[INIT] Preparing for root switch..."
mkdir -p /mnt/merged/mnt/system
mount --move /mnt/system /mnt/merged/mnt/system 2>/dev/null || true

# Create required directories
mkdir -p /mnt/merged/run
mkdir -p /mnt/merged/tmp
mkdir -p /mnt/merged/var/log

# Clean up
umount /proc 2>/dev/null
umount /sys 2>/dev/null
umount /dev 2>/dev/null

# Switch to new root
echo "[INIT] Switching to Quantix-OS..."
echo ""

cd /mnt/merged
pivot_root . mnt/initramfs 2>/dev/null || {
    exec switch_root /mnt/merged /sbin/init
}

# Execute init
exec /sbin/init

# Fallback
echo "[ERROR] Failed to start init!"
exec /bin/sh
