#!/bin/sh
# =============================================================================
# Quantix-OS Console Launcher
# =============================================================================
# Launches either:
#   - The Installer TUI (when booted with quantix.install=1)
#   - The Direct Console User Interface (DCUI) - for configured systems
#
# The installer provides:
# - Disk selection and partitioning
# - Storage pool configuration
# - Hostname and password setup
#
# The DCUI provides:
# - Network configuration (DHCP, static IP, WiFi)
# - SSH access management with security timer
# - Cluster join/leave functionality
# - System diagnostics and logs
# - Power management (reboot/shutdown)
# =============================================================================

set -e

LOG_FILE="/var/log/quantix-console.log"
INSTALL_MODE_MARKER="/tmp/.quantix_install_mode"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# Check if we're in install mode
is_install_mode() {
    # Check for marker file created by initramfs
    if [ -f "$INSTALL_MODE_MARKER" ]; then
        return 0
    fi
    
    # Also check kernel command line directly
    if grep -q "quantix.install" /proc/cmdline 2>/dev/null; then
        return 0
    fi
    
    return 1
}

# Start the installer TUI
start_installer() {
    log "Starting Quantix-OS Installer..."
    
    # Check if we've already failed (prevent infinite loop)
    FAIL_MARKER="/tmp/.quantix_install_failed"
    FAIL_COUNT=0
    if [ -f "$FAIL_MARKER" ]; then
        FAIL_COUNT=$(cat "$FAIL_MARKER" 2>/dev/null || echo "0")
        FAIL_COUNT=$((FAIL_COUNT + 1))
    fi
    echo "$FAIL_COUNT" > "$FAIL_MARKER"
    
    # After 2 failures, offer shell access
    if [ "$FAIL_COUNT" -ge 2 ]; then
        echo ""
        echo "╔════════════════════════════════════════════════════════════════╗"
        echo "║         INSTALLER HAS FAILED MULTIPLE TIMES                    ║"
        echo "╚════════════════════════════════════════════════════════════════╝"
        echo ""
        echo "  The installer has failed $FAIL_COUNT times."
        echo ""
        echo "  Options:"
        echo "    1) Press ENTER to drop to a shell for troubleshooting"
        echo "    2) Type 'retry' to try the installer again"
        echo "    3) Reboot and select 'Troubleshoot Shell' from the menu"
        echo ""
        printf "  Your choice: "
        read -t 30 choice || choice="shell"
        
        case "$choice" in
            retry|RETRY|r|R)
                echo "0" > "$FAIL_MARKER"
                log "User requested installer retry"
                ;;
            *)
                log "Dropping to troubleshooting shell after $FAIL_COUNT failures"
                echo ""
                echo "  Dropping to shell. Useful commands:"
                echo "    cat /tmp/install.log     - View install log"
                echo "    /installer/install.sh    - Run installer manually"
                echo "    blkid                    - List disk partitions"
                echo "    reboot                   - Reboot system"
                echo ""
                exec /bin/sh
                ;;
        esac
    fi
    
    # Wait a moment for boot messages to finish
    sleep 2
    
    # Reset terminal to sane state
    stty sane 2>/dev/null || true
    
    # Clear screen and scrollback
    printf '\033[2J\033[H\033[3J'
    
    # Debug: Show what we're looking for
    log "Searching for installer scripts..."
    log "Checking /mnt/cdrom/installer/:"
    ls -la /mnt/cdrom/installer/ 2>&1 | while read line; do log "  $line"; done
    log "Checking /installer/:"
    ls -la /installer/ 2>&1 | while read line; do log "  $line"; done
    
    # Check for installer scripts in various locations
    # First try tui.sh, then fall back to install.sh
    INSTALLER=""
    for path in \
        /mnt/cdrom/installer/tui.sh \
        /installer/tui.sh \
        /mnt/cdrom/installer/install.sh \
        /installer/install.sh; do
        log "Checking: $path"
        if [ -f "$path" ]; then
            log "  Found file: $path"
            # Make sure it's executable
            chmod +x "$path" 2>/dev/null || true
            INSTALLER="$path"
            break
        fi
    done
    
    if [ -n "$INSTALLER" ]; then
        log "Launching installer: $INSTALLER"
        exec /bin/sh "$INSTALLER"
    else
        log "ERROR: Installer not found!"
        echo ""
        echo "╔════════════════════════════════════════════════════════════════╗"
        echo "║             QUANTIX-OS INSTALLER - ERROR                       ║"
        echo "╚════════════════════════════════════════════════════════════════╝"
        echo ""
        echo "  The installer scripts were not found on the boot media."
        echo ""
        echo "  Expected locations:"
        echo "    - /mnt/cdrom/installer/tui.sh"
        echo "    - /installer/tui.sh"
        echo ""
        echo "  Please check that you're booting from a valid Quantix-OS ISO."
        echo ""
        echo "  Dropping to emergency shell..."
        echo ""
        exec /bin/sh
    fi
}

# Start DCUI (TUI) as the main console
start_dcui() {
    log "Starting DCUI (TUI) console..."
    
    # Wait a moment for boot messages to finish
    sleep 1
    
    # Reset terminal to sane state
    stty sane 2>/dev/null || true
    
    # Clear screen and scrollback
    printf '\033[2J\033[H\033[3J'
    
    # Check for OTA-updatable binary first, then fall back to squashfs version
    CONSOLE_BIN=""
    if [ -x /data/bin/qx-console ]; then
        CONSOLE_BIN="/data/bin/qx-console"
        log "Using OTA binary: $CONSOLE_BIN"
    elif [ -x /usr/local/bin/qx-console ]; then
        CONSOLE_BIN="/usr/local/bin/qx-console"
        log "Using squashfs binary: $CONSOLE_BIN"
    fi
    
    if [ -n "$CONSOLE_BIN" ]; then
        exec "$CONSOLE_BIN"
    else
        log "ERROR: TUI binary not found"
        echo ""
        echo "=========================================="
        echo "  QUANTIX-OS Direct Console (DCUI)"
        echo "=========================================="
        echo ""
        echo "TUI binary not found. Starting emergency shell."
        echo ""
        echo "To access the web management interface:"
        echo "  https://<this-host-ip>:8443"
        echo ""
        exec /bin/sh
    fi
}

# Main logic
main() {
    log "========================================"
    log "Quantix-OS Console Launcher"
    log "========================================"
    
    case "$1" in
        --help|-h)
            echo "Usage: $0"
            echo ""
            echo "Starts the Quantix-OS Direct Console User Interface (DCUI)"
            echo "or the Installer TUI if booted in install mode."
            echo ""
            echo "The DCUI provides:"
            echo "  - Network configuration (F2)"
            echo "  - SSH access management with timer (F3)"
            echo "  - Cluster join/leave (F4)"
            echo "  - Display refresh (F5)"
            echo "  - Restart management services (F6)"
            echo "  - View system logs (F7)"
            echo "  - Shutdown/Reboot (F10)"
            echo ""
            echo "For web-based management, access:"
            echo "  https://<host-ip>:8443"
            echo ""
            exit 0
            ;;
    esac
    
    # Check for install mode
    if is_install_mode; then
        log "Install mode detected - launching installer"
        start_installer
    else
        log "Normal mode - starting DCUI console"
        start_dcui
    fi
}

main "$@"
