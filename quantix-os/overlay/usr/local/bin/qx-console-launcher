#!/bin/sh
# =============================================================================
# Quantix-OS Console Launcher (DCUI Mode)
# =============================================================================
# Implements a VMware ESXi-style DCUI (Direct Console User Interface):
# - Shows Web Kiosk (React dashboard) when graphics are available
# - F10 key switches to TUI (always accessible, even without network)
# - TUI is the fallback for serial/SSH/headless sessions
# =============================================================================

set -e

# Configuration
WEBUI_URL="${QUANTIX_WEBUI_URL:-http://localhost:8443}"
LOG_FILE="/var/log/quantix-console.log"
DCUI_LOCKFILE="/tmp/.dcui-mode"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# Check if we're on a real TTY with graphics capability
check_graphics() {
    # Check for framebuffer device
    if [ -e /dev/fb0 ]; then
        return 0
    fi
    
    # Check for DRM devices
    if ls /dev/dri/card* >/dev/null 2>&1; then
        return 0
    fi
    
    return 1
}

# Check if we're on a serial console or SSH
is_serial_or_ssh() {
    # Check if SSH session
    if [ -n "$SSH_CONNECTION" ] || [ -n "$SSH_TTY" ]; then
        return 0
    fi
    
    # Check if serial console
    TTY=$(tty 2>/dev/null)
    case "$TTY" in
        /dev/ttyS*|/dev/ttyAMA*|/dev/ttyUSB*|/dev/hvc*)
            return 0
            ;;
    esac
    
    return 1
}

# Wait for the node daemon to be ready
wait_for_webui() {
    log "Waiting for Web UI at $WEBUI_URL..."
    
    MAX_WAIT=60
    WAITED=0
    
    while [ $WAITED -lt $MAX_WAIT ]; do
        # Try HTTP first, then HTTPS with --no-check-certificate
        if wget -q -O /dev/null --spider "$WEBUI_URL" 2>/dev/null; then
            log "Web UI is ready!"
            return 0
        fi
        # Try HTTPS (node daemon uses self-signed certs)
        if wget -q -O /dev/null --spider --no-check-certificate "https://localhost:8443" 2>/dev/null; then
            log "Web UI is ready (HTTPS)!"
            # Update URL to use HTTPS
            WEBUI_URL="https://localhost:8443"
            return 0
        fi
        # Also check if the port is listening (even if wget fails)
        if ss -tlnp 2>/dev/null | grep -q ':8443' || netstat -tlnp 2>/dev/null | grep -q ':8443'; then
            log "Port 8443 is listening, Web UI should be ready"
            return 0
        fi
        sleep 2
        WAITED=$((WAITED + 2))
        log "  Still waiting... ($WAITED/${MAX_WAIT}s)"
    done
    
    log "WARNING: Web UI not responding after ${MAX_WAIT}s"
    return 1
}

# Setup environment for Wayland/Cage
setup_wayland_env() {
    log "Setting up Wayland environment..."
    
    # XDG runtime directory (required for Wayland)
    export XDG_RUNTIME_DIR="${XDG_RUNTIME_DIR:-/run/user/0}"
    mkdir -p "$XDG_RUNTIME_DIR"
    chmod 700 "$XDG_RUNTIME_DIR"
    
    # Ensure seatd is running for seat management
    if ! pgrep -x seatd >/dev/null 2>&1; then
        log "Starting seatd daemon..."
        seatd -g video &
        sleep 1
    fi
    
    # Environment for libseat
    export LIBSEAT_BACKEND=seatd
    
    # =========================================================================
    # Mesa/EGL/DRI Configuration (CRITICAL for graphics)
    # =========================================================================
    
    # Set Mesa DRI driver search path (Alpine Linux locations)
    export LIBGL_DRIVERS_PATH="/usr/lib/dri:/usr/lib/xorg/modules/dri"
    export EGL_DRIVERS_PATH="/usr/lib/dri"
    
    # Allow software rendering as fallback (llvmpipe)
    export WLR_RENDERER_ALLOW_SOFTWARE=1
    export LIBGL_ALWAYS_SOFTWARE=0  # Try hardware first
    
    # Suppress non-critical DRI warnings
    export LIBGL_DRI3_DISABLE=0
    export MESA_GL_VERSION_OVERRIDE=3.3
    export MESA_GLSL_VERSION_OVERRIDE=330
    
    # Wayland-specific backend hints
    export WLR_BACKENDS="drm,libinput"
    export WLR_DRM_DEVICES="/dev/dri/card0:/dev/dri/card1"
    
    # For QEMU/VirtIO GPU
    export WLR_NO_HARDWARE_CURSORS=1
    
    # Debug output (comment out for production)
    # export WAYLAND_DEBUG=1
    # export MESA_DEBUG=1
    
    log "Wayland environment configured:"
    log "  XDG_RUNTIME_DIR=$XDG_RUNTIME_DIR"
    log "  LIBSEAT_BACKEND=$LIBSEAT_BACKEND"
    log "  LIBGL_DRIVERS_PATH=$LIBGL_DRIVERS_PATH"
    log "  WLR_RENDERER_ALLOW_SOFTWARE=$WLR_RENDERER_ALLOW_SOFTWARE"
}

# Start the Web Kiosk (Cage + Cog)
start_web_kiosk() {
    log "Starting Web Kiosk mode..."
    log "  Press F10 at any time to access DCUI (local configuration menu)"
    
    setup_wayland_env
    
    # Wait for node daemon to start the web UI
    if ! wait_for_webui; then
        log "Web UI not available, starting DCUI directly..."
        start_dcui
        return
    fi
    
    # Check for cage
    if ! command -v cage >/dev/null 2>&1; then
        log "ERROR: cage not found! Starting DCUI..."
        start_dcui
        return
    fi
    
    # Check for cog
    if ! command -v cog >/dev/null 2>&1; then
        log "ERROR: cog not found! Starting DCUI..."
        start_dcui
        return
    fi
    
    log "Launching Web Kiosk..."
    log "  URL: $WEBUI_URL"
    log ""
    log "  ┌─────────────────────────────────────────────────────────┐"
    log "  │  To access DCUI (local console), press:                 │"
    log "  │    Ctrl+Alt+F2  - Switch to text console                │"
    log "  │    Ctrl+Alt+F1  - Return to Web Kiosk                   │"
    log "  └─────────────────────────────────────────────────────────┘"
    log ""
    
    # Start TUI on VT2 in background
    log "Starting DCUI on VT2 (accessible via Ctrl+Alt+F2)..."
    (
        sleep 3  # Wait for kiosk to start
        openvt -c 2 -s -w -- /usr/local/bin/qx-console 2>/dev/null || true
    ) &
    
    # Track consecutive failures
    FAIL_COUNT=0
    MAX_FAILURES=3
    
    # Run the kiosk on VT1
    while true; do
        log "Launching cage with cog..."
        
        # Start cage with cog
        cage -- cog "$WEBUI_URL" 2>&1 | tee -a "$LOG_FILE"
        CAGE_EXIT=$?
        
        log "Cage exited with code: $CAGE_EXIT"
        
        # If cage crashed, track failures
        if [ $CAGE_EXIT -ne 0 ]; then
            FAIL_COUNT=$((FAIL_COUNT + 1))
            log "Web Kiosk failed ($FAIL_COUNT/$MAX_FAILURES)"
            
            # Check for EGL/DRI errors and try software rendering
            if grep -q "eglInitialize\|drm_dri\|DRI\|EGL" "$LOG_FILE" 2>/dev/null; then
                log "Graphics driver issue detected, enabling software rendering..."
                export LIBGL_ALWAYS_SOFTWARE=1
                export WLR_RENDERER=pixman
            fi
            
            # If we've failed too many times, fall back to DCUI
            if [ $FAIL_COUNT -ge $MAX_FAILURES ]; then
                log "Too many failures, falling back to DCUI (TUI)..."
                log ""
                log "  ┌─────────────────────────────────────────────────────────┐"
                log "  │  Web Kiosk failed to start - Graphics driver issue      │"
                log "  │  Starting DCUI (Text Console) instead...                │"
                log "  └─────────────────────────────────────────────────────────┘"
                log ""
                start_dcui
                return
            fi
            
            log "Restarting in 3 seconds..."
            sleep 3
            continue
        fi
        
        # Normal exit (success) - reset fail count and restart
        FAIL_COUNT=0
        log "Web Kiosk exited normally, restarting..."
        sleep 1
    done
}

# Start DCUI (TUI) session - returns when user exits
start_dcui_session() {
    log "Starting DCUI session..."
    
    # Switch to a text console VT if we were in graphics
    if check_graphics; then
        # Try to switch to VT2 for TUI
        chvt 2 2>/dev/null || true
    fi
    
if [ -x /usr/local/bin/qx-console ]; then
        /usr/local/bin/qx-console
    else
        log "TUI not available, starting shell"
        echo ""
        echo "=========================================="
        echo "  QUANTIX-OS Direct Console (DCUI)"
        echo "=========================================="
        echo ""
        echo "TUI binary not found. Starting emergency shell."
        echo "Type 'exit' to return to Web Kiosk."
        echo ""
        /bin/sh
    fi
    
    log "DCUI session ended"
}

# Start DCUI as the main console (no web kiosk)
start_dcui() {
    log "Starting DCUI (TUI) as primary console..."
    
    if [ -x /usr/local/bin/qx-console ]; then
        exec /usr/local/bin/qx-console
else
        log "TUI not available, starting shell"
        exec /bin/sh
    fi
}

# Main logic
main() {
    log "========================================"
    log "Quantix-OS Console Launcher (DCUI Mode)"
    log "========================================"
    
    # Check for force flags
    case "$1" in
        --gui|--kiosk|--web)
            log "Forcing Web Kiosk mode..."
            if check_graphics; then
                start_web_kiosk
            else
                log "No graphics available, falling back to DCUI"
                start_dcui
            fi
            ;;
        --tui|--dcui)
            log "Forcing DCUI (TUI) mode..."
            start_dcui
            ;;
        --help|-h)
            echo "Usage: $0 [--gui|--dcui]"
            echo ""
            echo "Options:"
            echo "  --gui, --kiosk, --web  Force Web Kiosk console"
            echo "  --tui, --dcui          Force Direct Console UI (TUI)"
            echo ""
            echo "Without options, automatically selects based on hardware."
            echo ""
            echo "In Web Kiosk mode:"
            echo "  Press F10 to access DCUI (local configuration menu)"
            echo ""
            echo "Environment variables:"
            echo "  QUANTIX_WEBUI_URL  URL for the web UI (default: http://localhost:8443)"
            exit 0
            ;;
    esac
    
    # Auto-detect best mode
    if is_serial_or_ssh; then
        log "Serial/SSH session detected, using DCUI..."
        start_dcui
    elif check_graphics; then
        log "Graphics hardware detected, starting Web Kiosk..."
        log "  TIP: Press F10 at any time to access DCUI for local configuration"
        start_web_kiosk
    else
        log "No graphics detected, using DCUI..."
        start_dcui
    fi
}

main "$@"
