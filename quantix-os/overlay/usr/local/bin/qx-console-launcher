#!/bin/sh
# =============================================================================
# Quantix-OS Console Launcher
# =============================================================================
# Automatically selects the best console interface based on available hardware:
# - GUI (Slint) if graphics are available
# - TUI (Ratatui) for serial/SSH/headless
# =============================================================================

# Check if we're on a real TTY with graphics capability
check_graphics() {
    # Check for framebuffer device
    if [ -e /dev/fb0 ]; then
        return 0
    fi
    
    # Check for DRM devices
    if ls /dev/dri/card* >/dev/null 2>&1; then
        return 0
    fi
    
    return 1
}

# Check if we're on a serial console or SSH
is_serial_or_ssh() {
    # Check if SSH session
    if [ -n "$SSH_CONNECTION" ] || [ -n "$SSH_TTY" ]; then
        return 0
    fi
    
    # Check if serial console
    TTY=$(tty 2>/dev/null)
    case "$TTY" in
        /dev/ttyS*|/dev/ttyAMA*|/dev/ttyUSB*|/dev/hvc*)
            return 0
            ;;
    esac
    
    return 1
}

# Main logic
main() {
    echo "Quantix-OS Console Launcher"
    echo "==========================="
    
    # Check for force flags
    case "$1" in
        --gui)
            echo "Forcing GUI mode..."
            exec /usr/bin/qx-console-gui "$@"
            ;;
        --tui)
            echo "Forcing TUI mode..."
            exec /usr/local/bin/qx-console "$@"
            ;;
        --help|-h)
            echo "Usage: $0 [--gui|--tui]"
            echo ""
            echo "Options:"
            echo "  --gui    Force graphical console (Slint)"
            echo "  --tui    Force text console (Ratatui)"
            echo ""
            echo "Without options, automatically selects based on hardware."
            exit 0
            ;;
    esac
    
    # Auto-detect best mode
    if is_serial_or_ssh; then
        echo "Serial/SSH detected, using TUI..."
        if [ -x /usr/local/bin/qx-console ]; then
            exec /usr/local/bin/qx-console "$@"
        else
            echo "TUI not available, falling back to shell"
            exec /bin/sh
        fi
    elif check_graphics; then
        echo "Graphics detected, using GUI..."
        if [ -x /usr/bin/qx-console-gui ]; then
            # Check if GUI binary can actually run (has all libraries)
            if ! ldd /usr/bin/qx-console-gui 2>&1 | grep -q "not found"; then
                # Set up environment for LinuxKMS/DRM
                export XDG_RUNTIME_DIR=/run/user/0
                export SLINT_BACKEND=linuxkms
                mkdir -p /run/user/0
                chmod 700 /run/user/0
                
                # Ensure seat access
                if command -v seatd-launch >/dev/null 2>&1; then
                    exec seatd-launch -- /usr/bin/qx-console-gui "$@"
                else
                    exec /usr/bin/qx-console-gui "$@"
                fi
            else
                echo "GUI binary missing libraries, falling back to TUI..."
                ldd /usr/bin/qx-console-gui 2>&1 | grep "not found" || true
            fi
        fi
        
        # Fall back to TUI
        echo "Falling back to TUI..."
        if [ -x /usr/local/bin/qx-console ]; then
            exec /usr/local/bin/qx-console "$@"
        else
            echo "No console available, starting shell"
            exec /bin/sh
        fi
    else
        echo "No graphics, using TUI..."
        if [ -x /usr/local/bin/qx-console ]; then
            exec /usr/local/bin/qx-console "$@"
        else
            echo "TUI not available, falling back to shell"
            exec /bin/sh
        fi
    fi
}

main "$@"
