#!/bin/sh
# ============================================================================
# Quantix Console Launcher - Slint GUI Only
# ============================================================================
# Launches the Slint GUI console. Falls back to emergency shell if GUI fails.
# TUI is disabled - we only support the graphical console.
# ============================================================================

# Function to print messages (visible during boot)
boot_msg() {
    echo "[QUANTIX] $1"
    echo "$(date '+%Y-%m-%dT%H:%M:%S') $1" >> /tmp/console-launcher.log 2>/dev/null || true
}

boot_msg "=== Quantix Console Launcher ==="

# ============================================================================
# Setup Environment
# ============================================================================

export XDG_RUNTIME_DIR="/run/user/0"
export XDG_SEAT="seat0"
export XDG_SESSION_TYPE="tty"
export HOME="/root"
export LIBSEAT_BACKEND="seatd"

# Create runtime directories
mkdir -p /run/user/0 /run/quantix 2>/dev/null || true
chmod 700 /run/user/0 2>/dev/null || true
chmod 755 /run/quantix 2>/dev/null || true

LOG_FILE="/run/quantix/console-launcher.log"

# ============================================================================
# Load Graphics and Input Modules
# ============================================================================

boot_msg "Loading graphics modules..."

# DRM core
modprobe drm 2>/dev/null || true
modprobe drm_kms_helper 2>/dev/null || true
modprobe ttm 2>/dev/null || true

# Virtual GPU drivers (VMware, QEMU, VirtualBox)
modprobe vmwgfx 2>/dev/null || true
modprobe virtio_gpu 2>/dev/null || true
modprobe vboxvideo 2>/dev/null || true
modprobe simpledrm 2>/dev/null || true
modprobe bochs 2>/dev/null || true

boot_msg "Loading input modules..."

# Input drivers
modprobe evdev 2>/dev/null || true
modprobe uinput 2>/dev/null || true
modprobe psmouse 2>/dev/null || true
modprobe mousedev 2>/dev/null || true
modprobe hid-generic 2>/dev/null || true

# Wait for udev to process
sleep 1

# Set input device permissions
chmod 666 /dev/input/event* 2>/dev/null || true
chmod 666 /dev/input/mice 2>/dev/null || true
chmod 666 /dev/input/mouse* 2>/dev/null || true
chmod 666 /dev/dri/card* 2>/dev/null || true
chmod 666 /dev/dri/renderD* 2>/dev/null || true

# ============================================================================
# Setup seatd (required for Slint LinuxKMS input)
# ============================================================================

boot_msg "Setting up seat management..."

# Kill any existing seatd with wrong config
pkill seatd 2>/dev/null || true
sleep 0.5

# Start seatd with root group
if [ -x /usr/bin/seatd ]; then
    /usr/bin/seatd -g root -l debug 2>/run/quantix/seatd.log &
    sleep 1
    
    # Verify it started
    if pgrep -x seatd >/dev/null 2>&1; then
        boot_msg "seatd started successfully"
    else
        boot_msg "WARNING: seatd failed to start"
    fi
fi

# Set socket permissions
chmod 777 /run/seatd.sock 2>/dev/null || true

# Add root to required groups
addgroup root video 2>/dev/null || true
addgroup root input 2>/dev/null || true
addgroup root seat 2>/dev/null || true
addgroup root tty 2>/dev/null || true

# ============================================================================
# Check Graphics Availability
# ============================================================================

has_drm() {
    for card in /sys/class/drm/card*; do
        if [ -d "$card" ] && [ "$(basename "$card")" != "card*" ]; then
            return 0
        fi
    done
    return 1
}

# Wait for graphics devices
boot_msg "Waiting for graphics devices..."
waited=0
while [ $waited -lt 5 ]; do
    if has_drm; then
        boot_msg "DRM device found"
        break
    fi
    sleep 1
    waited=$((waited + 1))
done

if ! has_drm; then
    boot_msg "ERROR: No DRM graphics device found"
    boot_msg "Slint LinuxKMS requires DRM. Dropping to shell."
    exec /bin/sh
fi

# Log available devices
boot_msg "Graphics devices:"
ls -la /dev/dri/ 2>/dev/null || boot_msg "  No /dev/dri"
boot_msg "Input devices:"
ls -la /dev/input/ 2>/dev/null || boot_msg "  No /dev/input"

# ============================================================================
# Launch Slint GUI
# ============================================================================

launch_slint_gui() {
    local backend="$1"
    boot_msg "Starting Slint GUI (backend: $backend)..."
    
    export SLINT_BACKEND="$backend"
    
    # Run the GUI
    /usr/bin/qx-console-gui 2>/run/quantix/console-gui.err
    local exit_code=$?
    
    if [ $exit_code -eq 0 ]; then
        boot_msg "GUI exited normally"
        return 0
    fi
    
    boot_msg "GUI exited with code: $exit_code"
    if [ -s /run/quantix/console-gui.err ]; then
        boot_msg "Error log:"
        cat /run/quantix/console-gui.err
    fi
    
    return $exit_code
}

# Check if GUI binary exists
if [ ! -x /usr/bin/qx-console-gui ]; then
    boot_msg "ERROR: qx-console-gui not found"
    exec /bin/sh
fi

# Try different Slint backends
boot_msg "Attempting to start Slint GUI..."

# Try 1: LinuxKMS with software renderer (most compatible)
launch_slint_gui "linuxkms-software" && exit 0

# Try 2: LinuxKMS with GPU (if software failed)
launch_slint_gui "linuxkms" && exit 0

# ============================================================================
# Fallback to Emergency Shell
# ============================================================================

boot_msg "============================================"
boot_msg "  SLINT GUI FAILED - EMERGENCY SHELL"
boot_msg "============================================"

clear 2>/dev/null || true
cat << 'EOF'

==========================================
  QUANTIX-OS EMERGENCY SHELL
==========================================

The Slint graphical console failed to start.

Diagnostic commands:
  cat /run/quantix/console-gui.err   # GUI error log
  cat /run/quantix/seatd.log         # Seat manager log
  ls -la /dev/dri/                   # Check DRM devices
  ls -la /dev/input/                 # Check input devices
  cat /proc/bus/input/devices        # Kernel input devices

To retry the GUI:
  export SLINT_BACKEND=linuxkms-software
  /usr/bin/qx-console-gui

==========================================
EOF

exec /bin/sh
