#!/bin/sh
# ============================================================================
# Quantix Console Launcher
# ============================================================================
# Tries to launch the Slint GUI console first.
# Falls back to TUI console if GUI fails (no KMS, no framebuffer, etc.)
# ============================================================================

# Setup environment
export XDG_RUNTIME_DIR="/run/user/0"
export HOME="/root"

# Ensure runtime directories exist (these are on tmpfs, so writable)
mkdir -p /run/user/0
chmod 700 /run/user/0

# Create log directory in /run (tmpfs, writable)
mkdir -p /run/quantix
chmod 755 /run/quantix

# Try Slint GUI console first (requires KMS/framebuffer)
if [ -x /usr/bin/qx-console-gui ]; then
    # Set Slint to use LinuxKMS backend (direct framebuffer)
    export SLINT_BACKEND="linuxkms"
    
    # Attempt to run the GUI (log to /run which is tmpfs)
    # The GUI needs direct access to tty1 for input/output
    echo "Starting Quantix-OS Console (GUI)..." > /dev/tty1
    /usr/bin/qx-console-gui </dev/tty1 >/dev/tty1 2>/run/quantix/console-gui.err
    
    # If we get here, the GUI exited (error or intentional)
    EXIT_CODE=$?
    
    if [ $EXIT_CODE -ne 0 ]; then
        # Show the error if available
        if [ -s /run/quantix/console-gui.err ]; then
            echo "GUI error:" > /dev/tty1
            head -5 /run/quantix/console-gui.err > /dev/tty1
        fi
        echo "GUI console failed (exit $EXIT_CODE), falling back to TUI..." > /dev/tty1
        sleep 3
    else
        # Normal exit (e.g., shutdown/reboot initiated)
        exit 0
    fi
fi

# Fallback to TUI console
if [ -x /usr/local/bin/qx-console ]; then
    echo "Starting Quantix-OS Console (TUI)..." > /dev/tty1
    exec /usr/local/bin/qx-console
fi

# Ultimate fallback: simple shell
echo "No console available, dropping to shell..." > /dev/tty1
exec /bin/sh
