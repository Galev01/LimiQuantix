#!/bin/sh
# =============================================================================
# Quantix-OS Console Launcher
# =============================================================================
# This script launches the appropriate console interface:
# 1. Try Slint GUI (qx-console-gui) - best experience
# 2. Fall back to TUI (qx-console) - works without GPU
# 3. Ultimate fallback: getty login prompt
# =============================================================================

set -e

LOG_FILE="/var/log/quantix-console.log"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$LOG_FILE"
}

# Ensure log directory exists
mkdir -p /var/log

log "Console launcher starting..."

# Check if we have a display (DRM/KMS)
if [ -e /dev/dri/card0 ]; then
    log "DRM device found, attempting GUI..."
    
    # Set environment for Slint LinuxKMS backend
    export SLINT_BACKEND=linuxkms
    export XDG_RUNTIME_DIR=/run/user/0
    mkdir -p "$XDG_RUNTIME_DIR"
    chmod 700 "$XDG_RUNTIME_DIR"
    
    # Try the Slint GUI
    if [ -x /usr/bin/qx-console-gui ]; then
        log "Starting Slint GUI console..."
        exec /usr/bin/qx-console-gui 2>> "$LOG_FILE"
    else
        log "GUI binary not found, falling back to TUI..."
    fi
else
    log "No DRM device found, skipping GUI..."
fi

# Fall back to TUI
if [ -x /usr/local/bin/qx-console ]; then
    log "Starting TUI console..."
    exec /usr/local/bin/qx-console 2>> "$LOG_FILE"
else
    log "TUI binary not found, falling back to getty..."
fi

# Ultimate fallback: getty
log "Falling back to getty..."
exec /sbin/getty 38400 tty1
