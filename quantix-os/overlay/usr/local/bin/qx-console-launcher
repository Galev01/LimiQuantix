#!/bin/sh
# =============================================================================
# Quantix-OS Console Launcher
# =============================================================================
# Automatically selects the best console interface based on available hardware:
# - GUI (Slint) if graphics are available and input works
# - TUI (Ratatui) for serial/SSH/headless or if GUI fails
# =============================================================================

# Check if we're on a real TTY with graphics capability
check_graphics() {
    # Check for framebuffer device
    if [ -e /dev/fb0 ]; then
        return 0
    fi
    
    # Check for DRM devices
    if ls /dev/dri/card* >/dev/null 2>&1; then
        return 0
    fi
    
    return 1
}

# Check if we're on a serial console or SSH
is_serial_or_ssh() {
    # Check if SSH session
    if [ -n "$SSH_CONNECTION" ] || [ -n "$SSH_TTY" ]; then
        return 0
    fi
    
    # Check if serial console
    TTY=$(tty 2>/dev/null)
    case "$TTY" in
        /dev/ttyS*|/dev/ttyAMA*|/dev/ttyUSB*|/dev/hvc*)
            return 0
            ;;
    esac
    
    return 1
}

# Setup environment for GUI
setup_gui_env() {
    # XDG runtime directory
    export XDG_RUNTIME_DIR=/run/user/0
    mkdir -p /run/user/0
    chmod 700 /run/user/0
    
    # Slint backend
    export SLINT_BACKEND=linuxkms
    
    # Ensure seatd is running
    if ! pgrep -x seatd >/dev/null 2>&1; then
        echo "Starting seatd daemon..."
        # Start seatd with video group access, non-daemonize for better control
        seatd -g video -n &
        sleep 1
    fi
    
    # Set seatd socket path for libseat (CRITICAL for input to work)
    export SEATD_VTHND_PATH=/run/seatd.sock
    export LIBSEAT_BACKEND=seatd
    
    # Ensure input devices are accessible
    # The input group should already have access via udev rules, but ensure permissions
    if [ -d /dev/input ]; then
        chmod 660 /dev/input/event* 2>/dev/null || true
        chgrp input /dev/input/event* 2>/dev/null || true
    fi
    
    echo "Environment configured:"
    echo "  XDG_RUNTIME_DIR=$XDG_RUNTIME_DIR"
    echo "  SLINT_BACKEND=$SLINT_BACKEND"
    echo "  SEATD_VTHND_PATH=$SEATD_VTHND_PATH"
    echo "  LIBSEAT_BACKEND=$LIBSEAT_BACKEND"
}

# Main logic
main() {
    echo "Quantix-OS Console Launcher"
    echo "==========================="
    
    # Check for force flags
    case "$1" in
        --gui)
            echo "Forcing GUI mode..."
            setup_gui_env
            exec /usr/bin/qx-console-gui
            ;;
        --tui)
            echo "Forcing TUI mode..."
            exec /usr/local/bin/qx-console
            ;;
        --help|-h)
            echo "Usage: $0 [--gui|--tui]"
            echo ""
            echo "Options:"
            echo "  --gui    Force graphical console (Slint)"
            echo "  --tui    Force text console (Ratatui)"
            echo ""
            echo "Without options, automatically selects based on hardware."
            exit 0
            ;;
    esac
    
    # Auto-detect best mode
    if is_serial_or_ssh; then
        echo "Serial/SSH detected, using TUI..."
        start_tui
    elif check_graphics; then
        echo "Graphics detected, trying GUI..."
        
        # Check if GUI binary exists and has all libraries
        if [ -x /usr/bin/qx-console-gui ]; then
            if ! ldd /usr/bin/qx-console-gui 2>&1 | grep -q "not found"; then
                setup_gui_env
                echo "Launching GUI..."
                exec /usr/bin/qx-console-gui
            else
                echo "GUI binary missing libraries:"
                ldd /usr/bin/qx-console-gui 2>&1 | grep "not found"
                echo "Falling back to TUI..."
            fi
        else
            echo "GUI binary not found, using TUI..."
        fi
        
        start_tui
    else
        echo "No graphics, using TUI..."
        start_tui
    fi
}

# Start TUI or fall back to shell
start_tui() {
    if [ -x /usr/local/bin/qx-console ]; then
        exec /usr/local/bin/qx-console
    else
        echo "TUI not available, starting shell"
        exec /bin/sh
    fi
}

main "$@"
