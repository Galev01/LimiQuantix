#!/bin/sh
# =============================================================================
# Quantix-OS Console Launcher
# =============================================================================
# Automatically selects the best console interface based on available hardware:
# - Web Kiosk (Cage + Cog) if graphics are available
# - TUI (Ratatui) for serial/SSH/headless or if GUI fails
# =============================================================================

set -e

# Configuration
WEBUI_URL="${QUANTIX_WEBUI_URL:-http://localhost:8443}"
LOG_FILE="/var/log/quantix-console.log"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# Check if we're on a real TTY with graphics capability
check_graphics() {
    # Check for framebuffer device
    if [ -e /dev/fb0 ]; then
        return 0
    fi
    
    # Check for DRM devices
    if ls /dev/dri/card* >/dev/null 2>&1; then
        return 0
    fi
    
    return 1
}

# Check if we're on a serial console or SSH
is_serial_or_ssh() {
    # Check if SSH session
    if [ -n "$SSH_CONNECTION" ] || [ -n "$SSH_TTY" ]; then
        return 0
    fi
    
    # Check if serial console
    TTY=$(tty 2>/dev/null)
    case "$TTY" in
        /dev/ttyS*|/dev/ttyAMA*|/dev/ttyUSB*|/dev/hvc*)
            return 0
            ;;
    esac
    
    return 1
}

# Wait for the node daemon to be ready
wait_for_webui() {
    log "Waiting for Web UI at $WEBUI_URL..."
    
    MAX_WAIT=60
    WAITED=0
    
    while [ $WAITED -lt $MAX_WAIT ]; do
        if wget -q -O /dev/null --spider "$WEBUI_URL" 2>/dev/null; then
            log "Web UI is ready!"
            return 0
        fi
        sleep 2
        WAITED=$((WAITED + 2))
    done
    
    log "WARNING: Web UI not responding after ${MAX_WAIT}s, starting anyway..."
    return 1
}

# Setup environment for Wayland/Cage
setup_wayland_env() {
    log "Setting up Wayland environment..."
    
    # XDG runtime directory (required for Wayland)
    export XDG_RUNTIME_DIR="${XDG_RUNTIME_DIR:-/run/user/0}"
    mkdir -p "$XDG_RUNTIME_DIR"
    chmod 700 "$XDG_RUNTIME_DIR"
    
    # Ensure seatd is running for seat management
    if ! pgrep -x seatd >/dev/null 2>&1; then
        log "Starting seatd daemon..."
        seatd -g video &
        sleep 1
    fi
    
    # Environment for libseat
    export LIBSEAT_BACKEND=seatd
    
    # Wayland-specific settings
    export WLR_RENDERER_ALLOW_SOFTWARE=1
    
    log "Wayland environment configured:"
    log "  XDG_RUNTIME_DIR=$XDG_RUNTIME_DIR"
    log "  LIBSEAT_BACKEND=$LIBSEAT_BACKEND"
}

# Start the Web Kiosk (Cage + Cog)
start_web_kiosk() {
    log "Starting Web Kiosk mode..."
    
    setup_wayland_env
    
    # Wait for node daemon to start the web UI
    wait_for_webui
    
    # Check for cage
    if ! command -v cage >/dev/null 2>&1; then
        log "ERROR: cage not found!"
        return 1
    fi
    
    # Check for cog
    if ! command -v cog >/dev/null 2>&1; then
        log "ERROR: cog not found!"
        return 1
    fi
    
    log "Launching cage with cog browser..."
    log "  URL: $WEBUI_URL"
    
    # Cage launches a single Wayland application in fullscreen kiosk mode
    # Cog is the WPE WebKit browser that loads our React dashboard
    # -s disables decorations (kiosk mode)
    exec cage -- cog "$WEBUI_URL"
}

# Start TUI console
start_tui() {
    log "Starting TUI console..."
    
    if [ -x /usr/local/bin/qx-console ]; then
        exec /usr/local/bin/qx-console
    else
        log "TUI not available, starting shell"
        exec /bin/sh
    fi
}

# Main logic
main() {
    log "========================================"
    log "Quantix-OS Console Launcher"
    log "========================================"
    
    # Check for force flags
    case "$1" in
        --gui|--kiosk|--web)
            log "Forcing Web Kiosk mode..."
            start_web_kiosk || start_tui
            ;;
        --tui)
            log "Forcing TUI mode..."
            start_tui
            ;;
        --help|-h)
            echo "Usage: $0 [--gui|--tui]"
            echo ""
            echo "Options:"
            echo "  --gui, --kiosk, --web  Force Web Kiosk console (Cage + Cog)"
            echo "  --tui                  Force text console (Ratatui)"
            echo ""
            echo "Without options, automatically selects based on hardware."
            echo ""
            echo "Environment variables:"
            echo "  QUANTIX_WEBUI_URL  URL for the web UI (default: http://localhost:8443)"
            exit 0
            ;;
    esac
    
    # Auto-detect best mode
    if is_serial_or_ssh; then
        log "Serial/SSH session detected, using TUI..."
        start_tui
    elif check_graphics; then
        log "Graphics hardware detected, trying Web Kiosk..."
        
        # Try web kiosk, fall back to TUI on failure
        start_web_kiosk || {
            log "Web Kiosk failed, falling back to TUI..."
            start_tui
        }
    else
        log "No graphics detected, using TUI..."
        start_tui
    fi
}

main "$@"
