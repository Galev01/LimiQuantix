#!/bin/sh
# ============================================================================
# Quantix Console Launcher
# ============================================================================
# Tries to launch the Slint GUI console with multiple rendering backends:
# 1. LinuxKMS with GPU (femtovg) - fastest, requires GPU/DRM
# 2. LinuxKMS with software renderer - works without GPU
# 3. Raw framebuffer (embedded-graphics) - bypasses DRM, uses /dev/fb0 directly
# 4. TUI fallback - terminal-based interface
# ============================================================================

# Setup environment
export XDG_RUNTIME_DIR="/run/user/0"
export HOME="/root"

# Ensure runtime directories exist (these are on tmpfs, so writable)
mkdir -p /run/user/0
chmod 700 /run/user/0

# Create log directory in /run (tmpfs, writable)
mkdir -p /run/quantix
chmod 755 /run/quantix

# Function to try running GUI with a specific backend
try_gui() {
    BACKEND="$1"
    BACKEND_NAME="$2"
    
    export SLINT_BACKEND="$BACKEND"
    echo "Starting Quantix-OS Console (GUI - $BACKEND_NAME)..." > /dev/tty1
    /usr/bin/qx-console-gui </dev/tty1 >/dev/tty1 2>/run/quantix/console-gui.err
    
    EXIT_CODE=$?
    
    if [ $EXIT_CODE -eq 0 ]; then
        # Normal exit (e.g., shutdown/reboot initiated)
        exit 0
    fi
    
    return $EXIT_CODE
}

# Try Slint GUI console if available
if [ -x /usr/bin/qx-console-gui ]; then
    # Try 1: LinuxKMS with GPU acceleration (femtovg)
    try_gui "linuxkms" "GPU"
    GPU_EXIT=$?
    
    # If GPU failed, try software rendering
    if [ $GPU_EXIT -ne 0 ]; then
        echo "GPU rendering failed, trying software renderer..." > /dev/tty1
        sleep 1
        
        # Try 2: LinuxKMS with software renderer (no GPU needed)
        try_gui "linuxkms-software" "Software"
        SW_EXIT=$?
        
        if [ $SW_EXIT -ne 0 ]; then
            # Slint failed, try raw framebuffer (no DRM/KMS needed)
            if [ -c /dev/fb0 ]; then
                echo "Slint failed, trying raw framebuffer..." > /dev/tty1
                sleep 1
                
                # Try 3: Raw framebuffer rendering (embedded-graphics)
                SLINT_BACKEND="" /usr/bin/qx-console-gui --framebuffer </dev/tty1 >/dev/tty1 2>/run/quantix/console-gui.err
                FB_EXIT=$?
                
                if [ $FB_EXIT -eq 0 ]; then
                    exit 0
                fi
            fi
            
            # All GUI backends failed, show error
            if [ -s /run/quantix/console-gui.err ]; then
                echo "GUI error:" > /dev/tty1
                head -5 /run/quantix/console-gui.err > /dev/tty1
            fi
            echo "GUI console failed, falling back to TUI..." > /dev/tty1
            sleep 2
        fi
    fi
fi

# Fallback to TUI console
if [ -x /usr/local/bin/qx-console ]; then
    echo "Starting Quantix-OS Console (TUI)..." > /dev/tty1
    exec /usr/local/bin/qx-console
fi

# Ultimate fallback: simple shell
echo "No console available, dropping to shell..." > /dev/tty1
exec /bin/sh
