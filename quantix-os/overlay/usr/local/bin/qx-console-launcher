#!/bin/sh
# =============================================================================
# Quantix-OS Console Launcher
# =============================================================================
# Selects the console interface:
# - TUI (Ratatui) - DEFAULT, works reliably
# - GUI (Slint) - Experimental, use --gui flag
# =============================================================================

# Main logic
main() {
    echo "Quantix-OS Console Launcher"
    echo "==========================="
    
    # Check for force flags
    case "$1" in
        --gui)
            echo "WARNING: GUI mode is experimental and may freeze!"
            echo "Starting GUI in 3 seconds... (Ctrl+C to cancel)"
            sleep 3
            setup_gui_env
            exec /usr/bin/qx-console-gui
            ;;
        --tui)
            echo "Starting TUI mode..."
            exec /usr/local/bin/qx-console
            ;;
        --help|-h)
            echo "Usage: $0 [--gui|--tui]"
            echo ""
            echo "Options:"
            echo "  --tui    Text console (Ratatui) - DEFAULT, recommended"
            echo "  --gui    Graphical console (Slint) - EXPERIMENTAL"
            echo ""
            echo "Default: TUI mode (GUI has stability issues)"
            exit 0
            ;;
    esac
    
    # DEFAULT: Use TUI - it works reliably
    echo "Starting TUI console (default)..."
    
    if [ -x /usr/local/bin/qx-console ]; then
        exec /usr/local/bin/qx-console
    else
        echo "TUI not available, starting shell"
        exec /bin/sh
    fi
}

# Setup GUI environment (experimental)
setup_gui_env() {
    export XDG_RUNTIME_DIR=/run/user/0
    export SLINT_BACKEND=linuxkms
    mkdir -p /run/user/0
    chmod 700 /run/user/0
    
    # Try to setup seatd
    rc-service seatd start 2>/dev/null || true
    addgroup root seat 2>/dev/null || true
    addgroup root input 2>/dev/null || true
    addgroup root video 2>/dev/null || true
    chmod 660 /dev/input/* 2>/dev/null || true
}

main "$@"
