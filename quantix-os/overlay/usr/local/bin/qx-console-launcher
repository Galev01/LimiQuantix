#!/bin/sh
# =============================================================================
# Quantix-OS Console Launcher
# =============================================================================
# Launches the Direct Console User Interface (DCUI) - a TUI-based console
# for initial system configuration, similar to VMware ESXi's DCUI.
#
# The TUI provides:
# - Network configuration (DHCP, static IP, WiFi)
# - SSH access management with security timer
# - Cluster join/leave functionality
# - System diagnostics and logs
# - Power management (reboot/shutdown)
# =============================================================================

set -e

LOG_FILE="/var/log/quantix-console.log"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# Start DCUI (TUI) as the main console
start_dcui() {
    log "Starting DCUI (TUI) console..."
    
    # Wait a moment for boot messages to finish
    sleep 1
    
    # Reset terminal to sane state
    stty sane 2>/dev/null || true
    
    # Clear screen and scrollback
    printf '\033[2J\033[H\033[3J'
    
    if [ -x /usr/local/bin/qx-console ]; then
        exec /usr/local/bin/qx-console
    else
        log "ERROR: TUI binary not found at /usr/local/bin/qx-console"
        echo ""
        echo "=========================================="
        echo "  QUANTIX-OS Direct Console (DCUI)"
        echo "=========================================="
        echo ""
        echo "TUI binary not found. Starting emergency shell."
        echo ""
        echo "To access the web management interface:"
        echo "  https://<this-host-ip>:8443"
        echo ""
        exec /bin/sh
    fi
}

# Main logic
main() {
    log "========================================"
    log "Quantix-OS Console Launcher"
    log "========================================"
    
    case "$1" in
        --help|-h)
            echo "Usage: $0"
            echo ""
            echo "Starts the Quantix-OS Direct Console User Interface (DCUI)."
            echo ""
            echo "The DCUI provides:"
            echo "  - Network configuration (F2)"
            echo "  - SSH access management with timer (F3)"
            echo "  - Cluster join/leave (F4)"
            echo "  - Display refresh (F5)"
            echo "  - Restart management services (F6)"
            echo "  - View system logs (F7)"
            echo "  - Shutdown/Reboot (F10)"
            echo ""
            echo "For web-based management, access:"
            echo "  https://<host-ip>:8443"
            echo ""
            exit 0
            ;;
    esac
    
    log "Starting DCUI console..."
    start_dcui
}

main "$@"
