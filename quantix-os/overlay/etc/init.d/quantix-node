#!/sbin/openrc-run
# =============================================================================
# Quantix-OS Node Daemon Service
# =============================================================================
# Manages the Quantix node daemon (qx-node).
# =============================================================================

name="Quantix Node Daemon"
description="Quantix-OS hypervisor management daemon"
# Use /data/bin for OTA-updatable binary, fall back to /usr/bin
command="/data/bin/qx-node"
command_args="--webui-path /data/share/quantix-host-ui --enable-https"
command_background="yes"
pidfile="/run/quantix-node.pid"
output_log="/var/log/quantix-node.log"
error_log="/var/log/quantix-node.err.log"

depend() {
    need net localmount
    after libvirtd ovsdb-server ovs-vswitchd quantix-firstboot
    provide quantix-node
}

start_pre() {
    # Ensure log directory exists
    mkdir -p /var/log
    
    # Ensure runtime directory exists
    mkdir -p /run/quantix
    mkdir -p /run/user/0
    chmod 700 /run/user/0
    
    # Ensure libvirt runtime directory exists
    mkdir -p /var/run/libvirt
    
    # Ensure virtio-serial socket directory for guest agent communication
    mkdir -p /var/run/quantix-kvm/vms
    
    # Ensure config directory exists
    mkdir -p /quantix
    mkdir -p /etc/limiquantix
    
    # Ensure certificates directory exists (for HTTPS)
    mkdir -p /etc/limiquantix/certs
    chmod 700 /etc/limiquantix/certs
    
    # Check if binary exists in /data/bin (OTA), fall back to /usr/bin
    if [ ! -x "$command" ]; then
        if [ -x "/usr/bin/qx-node" ]; then
            ewarn "Using /usr/bin/qx-node (OTA binary not found)"
            command="/usr/bin/qx-node"
            command_args="--webui-path /usr/share/quantix-host-ui --enable-https"
        else
            eerror "Node daemon binary not found: $command"
            return 1
        fi
    fi
    
    # Wait for libvirtd to be ready
    local retries=10
    while [ $retries -gt 0 ]; do
        if [ -S /var/run/libvirt/libvirt-sock ]; then
            einfo "libvirtd socket is ready"
            break
        fi
        ewarn "Waiting for libvirtd socket..."
        sleep 1
        retries=$((retries - 1))
    done
    
    if [ ! -S /var/run/libvirt/libvirt-sock ]; then
        ewarn "libvirtd socket not found, node may fail to connect"
    fi
    
    return 0
}

start() {
    ebegin "Starting $name"
    
    start-stop-daemon --start \
        --background \
        --make-pidfile \
        --pidfile "$pidfile" \
        --stdout "$output_log" \
        --stderr "$error_log" \
        --exec "$command" \
        -- $command_args
    
    eend $?
}

stop() {
    ebegin "Stopping $name"
    
    start-stop-daemon --stop \
        --pidfile "$pidfile" \
        --retry TERM/30/KILL/5
    
    eend $?
}

status() {
    if [ -f "$pidfile" ]; then
        if kill -0 $(cat "$pidfile") 2>/dev/null; then
            einfo "$name is running (PID: $(cat $pidfile))"
            return 0
        fi
    fi
    
    einfo "$name is not running"
    return 3
}
