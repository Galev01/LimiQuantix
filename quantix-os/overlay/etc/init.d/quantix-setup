#!/sbin/openrc-run
# ============================================================================
# Quantix-OS Setup Service
# ============================================================================
# Creates writable directories needed by services running on read-only root.
# Must run early, before networking and virtualization services.
# ============================================================================

name="Quantix Setup"
description="Create writable directories for Quantix-OS services"

depend() {
    before networking ovsdb-server ovs-vswitchd libvirtd
    after localmount
}

start() {
    ebegin "Setting up Quantix-OS directories"
    
    # Core directories - /quantix stores persistent configuration
    mkdir -p /quantix /data /tmp /run
    chmod 755 /quantix /data
    
    # Console directories (for Slint GUI)
    mkdir -p /run/user/0
    chmod 700 /run/user/0
    
    # Seatd directories (for KMS session management)
    mkdir -p /run/seatd
    chmod 755 /run/seatd
    
    # OVS directories
    mkdir -p /var/run/openvswitch
    mkdir -p /var/log/openvswitch
    mkdir -p /etc/openvswitch
    chmod 755 /var/run/openvswitch /var/log/openvswitch /etc/openvswitch
    
    # Initialize OVS database if missing
    if [ ! -f /etc/openvswitch/conf.db ]; then
        if [ -f /usr/share/openvswitch/vswitch.ovsschema ]; then
            ovsdb-tool create /etc/openvswitch/conf.db /usr/share/openvswitch/vswitch.ovsschema 2>/dev/null
            einfo "Initialized OVS database"
        fi
    fi
    
    # Libvirt directories
    mkdir -p /var/run/libvirt
    mkdir -p /var/log/libvirt/qemu
    mkdir -p /var/lib/libvirt/images
    mkdir -p /var/lib/libvirt/qemu
    mkdir -p /var/lib/libvirt/dnsmasq
    mkdir -p /var/cache/libvirt/qemu
    mkdir -p /etc/libvirt/qemu/networks
    mkdir -p /etc/libvirt/qemu/autostart
    chmod 755 /var/run/libvirt /var/log/libvirt /var/lib/libvirt
    
    # QEMU directories
    mkdir -p /var/lib/qemu
    mkdir -p /var/cache/qemu
    
    # Quantix directories
    mkdir -p /var/lib/quantix
    mkdir -p /var/log/quantix
    
    # Runtime directories
    mkdir -p /run/lock
    mkdir -p /run/dbus
    mkdir -p /run/udev
    
    # DNS config
    if [ ! -f /run/resolv.conf ]; then
        echo "nameserver 8.8.8.8" > /run/resolv.conf
        echo "nameserver 8.8.4.4" >> /run/resolv.conf
    fi
    
    # Check for first boot
    if [ ! -f /quantix/.setup_complete ]; then
        einfo "First boot detected - installation wizard will run"
    fi
    
    eend 0
}

stop() {
    return 0
}
