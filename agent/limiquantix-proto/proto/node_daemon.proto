syntax = "proto3";

package Quantixkvm.node.v1;

import "google/protobuf/empty.proto";
import "google/protobuf/timestamp.proto";

// =============================================================================
// NODE DAEMON SERVICE
// =============================================================================
// This service runs on each hypervisor node and is called by the control plane
// to manage VMs directly on the physical host.

service NodeDaemonService {
  // Health check endpoint
  rpc HealthCheck(HealthCheckRequest) returns (HealthCheckResponse);
  
  // Get node information and capabilities
  rpc GetNodeInfo(google.protobuf.Empty) returns (NodeInfoResponse);
  
  // VM Lifecycle Operations
  rpc CreateVM(CreateVMRequest) returns (CreateVMResponse);
  rpc StartVM(VMIdRequest) returns (google.protobuf.Empty);
  rpc StopVM(StopVMRequest) returns (google.protobuf.Empty);
  rpc ForceStopVM(VMIdRequest) returns (google.protobuf.Empty);
  rpc RebootVM(VMIdRequest) returns (google.protobuf.Empty);
  rpc PauseVM(VMIdRequest) returns (google.protobuf.Empty);
  rpc ResumeVM(VMIdRequest) returns (google.protobuf.Empty);
  rpc DeleteVM(VMIdRequest) returns (google.protobuf.Empty);
  
  // VM Status
  rpc GetVMStatus(VMIdRequest) returns (VMStatusResponse);
  rpc ListVMs(google.protobuf.Empty) returns (ListVMsResponse);
  
  // Console
  rpc GetConsole(VMIdRequest) returns (ConsoleInfoResponse);
  
  // Snapshots
  rpc CreateSnapshot(CreateSnapshotRequest) returns (SnapshotResponse);
  rpc RevertSnapshot(RevertSnapshotRequest) returns (google.protobuf.Empty);
  rpc DeleteSnapshot(DeleteSnapshotRequest) returns (google.protobuf.Empty);
  rpc ListSnapshots(VMIdRequest) returns (ListSnapshotsResponse);
  
  // Metrics & Events (Streaming)
  rpc StreamMetrics(StreamMetricsRequest) returns (stream NodeMetrics);
  rpc StreamEvents(google.protobuf.Empty) returns (stream NodeEvent);
}

// =============================================================================
// REQUEST/RESPONSE MESSAGES
// =============================================================================

message HealthCheckRequest {}

message HealthCheckResponse {
  bool healthy = 1;
  string version = 2;
  string hypervisor = 3;
  string hypervisor_version = 4;
  uint64 uptime_seconds = 5;
}

message NodeInfoResponse {
  string node_id = 1;
  string hostname = 2;
  string management_ip = 3;
  
  // Hardware info
  string cpu_model = 4;
  uint32 cpu_cores = 5;
  uint64 memory_total_bytes = 6;
  uint64 memory_available_bytes = 7;
  
  // OS info
  string os_name = 8;
  string os_version = 9;
  string kernel_version = 10;
  uint64 uptime_seconds = 11;
  
  // Hypervisor capabilities
  string hypervisor_name = 12;
  string hypervisor_version = 13;
  bool supports_live_migration = 14;
  bool supports_snapshots = 15;
  bool supports_hotplug = 16;
  uint32 max_vcpus = 17;
  uint64 max_memory_bytes = 18;
}

message VMIdRequest {
  string vm_id = 1;
}

message CreateVMRequest {
  string vm_id = 1;
  string name = 2;
  
  // CPU configuration
  uint32 cpu_cores = 3;
  uint32 cpu_sockets = 4;
  uint32 cpu_threads = 5;
  
  // Memory configuration (in MiB)
  uint64 memory_mib = 6;
  
  // Disks
  repeated DiskSpec disks = 7;
  
  // Network interfaces
  repeated NicSpec nics = 8;
  
  // Boot configuration
  Firmware firmware = 9;
  
  // Console
  bool vnc_enabled = 10;
  
  // Labels
  map<string, string> labels = 11;
}

message DiskSpec {
  string id = 1;
  string path = 2;
  uint64 size_gib = 3;
  DiskBus bus = 4;
  DiskFormat format = 5;
  bool readonly = 6;
  bool bootable = 7;
}

enum DiskBus {
  DISK_BUS_VIRTIO = 0;
  DISK_BUS_SCSI = 1;
  DISK_BUS_SATA = 2;
  DISK_BUS_IDE = 3;
}

enum DiskFormat {
  DISK_FORMAT_QCOW2 = 0;
  DISK_FORMAT_RAW = 1;
}

message NicSpec {
  string id = 1;
  string mac_address = 2;
  string bridge = 3;
  string network = 4;
  NicModel model = 5;
}

enum NicModel {
  NIC_MODEL_VIRTIO = 0;
  NIC_MODEL_E1000 = 1;
  NIC_MODEL_RTL8139 = 2;
}

enum Firmware {
  FIRMWARE_BIOS = 0;
  FIRMWARE_UEFI = 1;
}

message CreateVMResponse {
  string vm_id = 1;
  bool created = 2;
  string message = 3;
}

message StopVMRequest {
  string vm_id = 1;
  uint32 timeout_seconds = 2;
}

message VMStatusResponse {
  string vm_id = 1;
  string name = 2;
  PowerState state = 3;
  double cpu_usage_percent = 4;
  uint64 memory_used_bytes = 5;
  uint64 memory_total_bytes = 6;
  google.protobuf.Timestamp started_at = 7;
}

enum PowerState {
  POWER_STATE_UNKNOWN = 0;
  POWER_STATE_RUNNING = 1;
  POWER_STATE_STOPPED = 2;
  POWER_STATE_PAUSED = 3;
  POWER_STATE_SUSPENDED = 4;
  POWER_STATE_CRASHED = 5;
}

message ListVMsResponse {
  repeated VMStatusResponse vms = 1;
}

message ConsoleInfoResponse {
  string console_type = 1;  // "vnc" or "spice"
  string host = 2;
  uint32 port = 3;
  string password = 4;
  string websocket_path = 5;
}

message CreateSnapshotRequest {
  string vm_id = 1;
  string name = 2;
  string description = 3;
  bool quiesce = 4;
}

message SnapshotResponse {
  string snapshot_id = 1;
  string name = 2;
  string description = 3;
  google.protobuf.Timestamp created_at = 4;
  PowerState vm_state = 5;
  string parent_id = 6;
}

message RevertSnapshotRequest {
  string vm_id = 1;
  string snapshot_id = 2;
}

message DeleteSnapshotRequest {
  string vm_id = 1;
  string snapshot_id = 2;
}

message ListSnapshotsResponse {
  repeated SnapshotResponse snapshots = 1;
}

message StreamMetricsRequest {
  uint32 interval_seconds = 1;
}

message NodeMetrics {
  google.protobuf.Timestamp timestamp = 1;
  double cpu_usage_percent = 2;
  uint64 memory_used_bytes = 3;
  uint64 memory_total_bytes = 4;
  repeated VMMetrics vms = 5;
}

message VMMetrics {
  string vm_id = 1;
  string name = 2;
  double cpu_usage_percent = 3;
  uint64 memory_used_bytes = 4;
  uint64 disk_read_bytes = 5;
  uint64 disk_write_bytes = 6;
  uint64 network_rx_bytes = 7;
  uint64 network_tx_bytes = 8;
}

message NodeEvent {
  string id = 1;
  google.protobuf.Timestamp timestamp = 2;
  EventType type = 3;
  string vm_id = 4;
  string message = 5;
  map<string, string> metadata = 6;
}

enum EventType {
  EVENT_TYPE_UNKNOWN = 0;
  EVENT_TYPE_VM_STARTED = 1;
  EVENT_TYPE_VM_STOPPED = 2;
  EVENT_TYPE_VM_PAUSED = 3;
  EVENT_TYPE_VM_RESUMED = 4;
  EVENT_TYPE_VM_CRASHED = 5;
  EVENT_TYPE_VM_REBOOTED = 6;
  EVENT_TYPE_SNAPSHOT_CREATED = 7;
  EVENT_TYPE_SNAPSHOT_REVERTED = 8;
  EVENT_TYPE_SNAPSHOT_DELETED = 9;
  EVENT_TYPE_NODE_OVERLOADED = 10;
  EVENT_TYPE_NODE_RECOVERED = 11;
}

