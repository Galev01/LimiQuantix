#cloud-config
# LimiQuantix Guest Agent Installation Script
# 
# This cloud-init user-data script automatically installs the LimiQuantix
# Guest Agent inside the VM during first boot.
#
# Usage:
# 1. Set this as the user_data when creating a VM
# 2. The agent will be installed and started automatically
# 3. The agent connects via virtio-serial (no network required)

# Run commands on first boot
runcmd:
  # Determine OS type and install agent
  - |
    #!/bin/bash
    set -e
    
    AGENT_VERSION="0.1.0"
    DOWNLOAD_BASE="https://releases.limiquantix.io/agent"
    
    echo "[LimiQuantix] Installing Guest Agent v${AGENT_VERSION}..."
    
    # Detect OS
    if [ -f /etc/os-release ]; then
      . /etc/os-release
      OS_ID="${ID}"
      OS_VERSION="${VERSION_ID}"
    else
      echo "[LimiQuantix] Cannot detect OS, assuming Debian-based"
      OS_ID="debian"
    fi
    
    echo "[LimiQuantix] Detected OS: ${OS_ID} ${OS_VERSION}"
    
    # Install based on OS
    case "${OS_ID}" in
      ubuntu|debian)
        # Download and install .deb package
        DEB_URL="${DOWNLOAD_BASE}/v${AGENT_VERSION}/limiquantix-guest-agent_${AGENT_VERSION}_amd64.deb"
        echo "[LimiQuantix] Downloading from ${DEB_URL}..."
        
        # Try wget first, fall back to curl
        if command -v wget &> /dev/null; then
          wget -q -O /tmp/limiquantix-agent.deb "${DEB_URL}" || true
        elif command -v curl &> /dev/null; then
          curl -sL -o /tmp/limiquantix-agent.deb "${DEB_URL}" || true
        fi
        
        if [ -f /tmp/limiquantix-agent.deb ]; then
          dpkg -i /tmp/limiquantix-agent.deb || apt-get install -f -y
          rm -f /tmp/limiquantix-agent.deb
        else
          echo "[LimiQuantix] Download failed, installing from binary..."
          install_binary
        fi
        ;;
        
      rhel|centos|fedora|rocky|almalinux)
        # Download and install .rpm package
        RPM_URL="${DOWNLOAD_BASE}/v${AGENT_VERSION}/limiquantix-guest-agent-${AGENT_VERSION}-1.x86_64.rpm"
        echo "[LimiQuantix] Downloading from ${RPM_URL}..."
        
        if command -v wget &> /dev/null; then
          wget -q -O /tmp/limiquantix-agent.rpm "${RPM_URL}" || true
        elif command -v curl &> /dev/null; then
          curl -sL -o /tmp/limiquantix-agent.rpm "${RPM_URL}" || true
        fi
        
        if [ -f /tmp/limiquantix-agent.rpm ]; then
          rpm -ivh /tmp/limiquantix-agent.rpm || yum localinstall -y /tmp/limiquantix-agent.rpm
          rm -f /tmp/limiquantix-agent.rpm
        else
          echo "[LimiQuantix] Download failed, installing from binary..."
          install_binary
        fi
        ;;
        
      *)
        echo "[LimiQuantix] Unknown OS, installing from binary..."
        install_binary
        ;;
    esac
    
    # Verify installation
    if systemctl is-active --quiet limiquantix-agent; then
      echo "[LimiQuantix] Guest Agent installed and running successfully!"
    else
      echo "[LimiQuantix] Starting Guest Agent..."
      systemctl start limiquantix-agent || true
    fi
    
    # Helper function to install from binary
    install_binary() {
      BIN_URL="${DOWNLOAD_BASE}/v${AGENT_VERSION}/limiquantix-agent-linux-amd64"
      
      echo "[LimiQuantix] Downloading binary from ${BIN_URL}..."
      
      if command -v wget &> /dev/null; then
        wget -q -O /usr/local/bin/limiquantix-agent "${BIN_URL}"
      elif command -v curl &> /dev/null; then
        curl -sL -o /usr/local/bin/limiquantix-agent "${BIN_URL}"
      else
        echo "[LimiQuantix] ERROR: Neither wget nor curl available"
        exit 1
      fi
      
      chmod +x /usr/local/bin/limiquantix-agent
      
      # Create systemd service
      cat > /etc/systemd/system/limiquantix-agent.service << 'EOF'
    [Unit]
    Description=LimiQuantix Guest Agent
    After=network.target

    [Service]
    Type=simple
    ExecStart=/usr/local/bin/limiquantix-agent
    Restart=always
    RestartSec=5

    [Install]
    WantedBy=multi-user.target
    EOF
      
      systemctl daemon-reload
      systemctl enable limiquantix-agent
      systemctl start limiquantix-agent
    }

# Write a marker file to indicate agent was installed via cloud-init
write_files:
  - path: /etc/limiquantix/cloud-init-installed
    content: |
      # LimiQuantix Guest Agent installed via cloud-init
      installed_at=$(date -Iseconds)
      version=0.1.0
    permissions: '0644'

# Final message
final_message: |
  LimiQuantix Guest Agent installation complete!
  The agent is now connected to the hypervisor.
  
  Check status with: systemctl status limiquantix-agent
