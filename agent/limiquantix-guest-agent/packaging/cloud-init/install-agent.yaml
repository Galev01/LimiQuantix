#cloud-config
# =============================================================================
# Quantix KVM Guest Agent Cloud-Init Installation
# =============================================================================
# This cloud-init configuration automatically installs the Quantix KVM Guest
# Agent during VM provisioning.
#
# Usage:
#   Include this file as user-data when creating a VM, or merge it with your
#   existing cloud-init configuration.
#
# The script will:
#   1. Detect the Linux distribution
#   2. Download the appropriate package (DEB or RPM)
#   3. Install the package
#   4. Start the agent service
# =============================================================================

# Update package cache first
package_update: true

# Run commands after boot
runcmd:
  - |
    #!/bin/bash
    set -e
    
    # Configuration
    AGENT_VERSION="${AGENT_VERSION:-latest}"
    DOWNLOAD_BASE="${DOWNLOAD_BASE:-https://releases.quantix.io/agent}"
    
    echo "Installing Quantix KVM Guest Agent v${AGENT_VERSION}..."
    
    # Detect distribution
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        DISTRO_ID="${ID}"
        DISTRO_VERSION="${VERSION_ID}"
    else
        echo "Cannot detect distribution"
        exit 1
    fi
    
    # Detect architecture
    ARCH=$(uname -m)
    case "${ARCH}" in
        x86_64)
            PKG_ARCH="amd64"
            ;;
        aarch64)
            PKG_ARCH="arm64"
            ;;
        *)
            echo "Unsupported architecture: ${ARCH}"
            exit 1
            ;;
    esac
    
    # Install based on distribution
    case "${DISTRO_ID}" in
        ubuntu|debian|linuxmint|pop)
            echo "Detected Debian-based distribution: ${DISTRO_ID}"
            
            # Download DEB package
            DEB_URL="${DOWNLOAD_BASE}/${AGENT_VERSION}/quantix-kvm-agent_${AGENT_VERSION}_${PKG_ARCH}.deb"
            curl -fsSL "${DEB_URL}" -o /tmp/agent.deb
            
            # Install
            dpkg -i /tmp/agent.deb || apt-get install -f -y
            rm /tmp/agent.deb
            ;;
            
        rhel|centos|fedora|rocky|almalinux|ol)
            echo "Detected RHEL-based distribution: ${DISTRO_ID}"
            
            # Download RPM package
            RPM_URL="${DOWNLOAD_BASE}/${AGENT_VERSION}/quantix-kvm-agent-${AGENT_VERSION}-1.${PKG_ARCH}.rpm"
            curl -fsSL "${RPM_URL}" -o /tmp/agent.rpm
            
            # Install
            if command -v dnf &> /dev/null; then
                dnf install -y /tmp/agent.rpm
            else
                yum install -y /tmp/agent.rpm
            fi
            rm /tmp/agent.rpm
            ;;
            
        opensuse*|sles)
            echo "Detected SUSE-based distribution: ${DISTRO_ID}"
            
            # Download RPM package
            RPM_URL="${DOWNLOAD_BASE}/${AGENT_VERSION}/quantix-kvm-agent-${AGENT_VERSION}-1.${PKG_ARCH}.rpm"
            curl -fsSL "${RPM_URL}" -o /tmp/agent.rpm
            
            # Install
            zypper install -y /tmp/agent.rpm
            rm /tmp/agent.rpm
            ;;
            
        arch|manjaro)
            echo "Detected Arch-based distribution: ${DISTRO_ID}"
            
            # Download tarball and install manually
            TAR_URL="${DOWNLOAD_BASE}/${AGENT_VERSION}/quantix-kvm-agent-${AGENT_VERSION}-linux-${PKG_ARCH}.tar.gz"
            curl -fsSL "${TAR_URL}" -o /tmp/agent.tar.gz
            
            cd /tmp
            tar -xzf agent.tar.gz
            cd quantix-kvm-agent-*
            ./install.sh
            cd /
            rm -rf /tmp/agent.tar.gz /tmp/quantix-kvm-agent-*
            ;;
            
        alpine)
            echo "Detected Alpine Linux"
            
            # Download tarball and install manually
            TAR_URL="${DOWNLOAD_BASE}/${AGENT_VERSION}/quantix-kvm-agent-${AGENT_VERSION}-linux-${PKG_ARCH}.tar.gz"
            curl -fsSL "${TAR_URL}" -o /tmp/agent.tar.gz
            
            cd /tmp
            tar -xzf agent.tar.gz
            cd quantix-kvm-agent-*
            
            # Install binary
            install -m 755 quantix-kvm-agent /usr/local/bin/
            
            # Create OpenRC service
            cat > /etc/init.d/quantix-kvm-agent << 'OPENRC'
    #!/sbin/openrc-run
    
    name="Quantix KVM Guest Agent"
    description="VM integration agent for Quantix KVM"
    command="/usr/local/bin/quantix-kvm-agent"
    command_background="yes"
    pidfile="/run/${RC_SVCNAME}.pid"
    
    depend() {
        need net
        after firewall
    }
    OPENRC
            chmod +x /etc/init.d/quantix-kvm-agent
            rc-update add quantix-kvm-agent default
            rc-service quantix-kvm-agent start
            
            cd /
            rm -rf /tmp/agent.tar.gz /tmp/quantix-kvm-agent-*
            ;;
            
        *)
            echo "Unsupported distribution: ${DISTRO_ID}"
            echo "Please install manually from ${DOWNLOAD_BASE}"
            exit 1
            ;;
    esac
    
    # Verify installation
    if systemctl is-active --quiet quantix-kvm-agent 2>/dev/null; then
        echo "Quantix KVM Guest Agent installed and running!"
    elif rc-service quantix-kvm-agent status 2>/dev/null | grep -q "started"; then
        echo "Quantix KVM Guest Agent installed and running!"
    else
        echo "Warning: Agent may not be running. Check logs."
    fi
    
    echo "Installation complete!"

# Write files for custom configuration (optional)
write_files:
  - path: /etc/quantix-kvm/agent.yaml
    owner: root:root
    permissions: '0644'
    defer: true
    content: |
      # Quantix KVM Guest Agent Configuration
      # Generated by cloud-init
      
      telemetry_interval_secs: 5
      max_exec_timeout_secs: 300
      max_chunk_size: 65536
      
      log_level: info
      log_format: json
      log_file: ""
      
      device_path: auto
      
      pre_freeze_script_dir: /etc/quantix-kvm/pre-freeze.d
      post_thaw_script_dir: /etc/quantix-kvm/post-thaw.d
      
      security:
        command_allowlist: []
        command_blocklist: []
        allow_file_write_paths: []
        deny_file_read_paths: []
        max_commands_per_minute: 0
        max_file_ops_per_second: 0
        audit_logging: false
      
      health:
        enabled: true
        interval_secs: 30
        telemetry_timeout_secs: 60

# Final message
final_message: |
  Quantix KVM Guest Agent cloud-init completed!
  Agent status: systemctl status quantix-kvm-agent
  Configuration: /etc/quantix-kvm/agent.yaml
